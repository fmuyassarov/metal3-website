<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>CAPM3 - Metal³ Book</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../../favicon.png">
        
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../../introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="../../../overview/project-overview.html"><strong aria-hidden="true">1.</strong> Project Overview</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../overview/metal3-components.html"><strong aria-hidden="true">1.1.</strong> Metal³ Components</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../overview/capm3/capm3.html"><strong aria-hidden="true">1.1.1.</strong> Cluster-Api-Provider-Metal³</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../overview/capm3/workflow.html"><strong aria-hidden="true">1.1.1.1.</strong> Workflow</a></li><li class="chapter-item expanded "><a href="../../../overview/capm3/api.html"><strong aria-hidden="true">1.1.1.2.</strong> API concepts</a></li></ol></li><li class="chapter-item expanded "><a href="../../../overview/bmo/bmo.html"><strong aria-hidden="true">1.1.2.</strong> Baremetal Operator</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../overview/bmo/ironic-integration.html"><strong aria-hidden="true">1.1.2.1.</strong> Ironic Integration</a></li><li class="chapter-item expanded "><a href="../../../overview/bmo/bmh-states.html"><strong aria-hidden="true">1.1.2.2.</strong> BaremetalHost Provisioning States</a></li><li class="chapter-item expanded "><a href="../../../overview/bmo/workflow.html"><strong aria-hidden="true">1.1.2.3.</strong> Workflow</a></li><li class="chapter-item expanded "><a href="../../../overview/bmo/api.html"><strong aria-hidden="true">1.1.2.4.</strong> API concepts</a></li></ol></li><li class="chapter-item expanded "><a href="../../../overview/metal3-dev-env.html"><strong aria-hidden="true">1.1.3.</strong> Metal³-Dev-Env</a></li><li class="chapter-item expanded "><a href="../../../overview/ipam/ip-address-manager.html"><strong aria-hidden="true">1.1.4.</strong> Ip-Address-Manager</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../overview/ipam/workflow.html"><strong aria-hidden="true">1.1.4.1.</strong> Workflow</a></li><li class="chapter-item expanded "><a href="../../../overview/ipam/api.html"><strong aria-hidden="true">1.1.4.2.</strong> API concepts</a></li></ol></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../../developer/developer-guide.html"><strong aria-hidden="true">2.</strong> Developer Guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../developer/testing.html"><strong aria-hidden="true">2.1.</strong> Testing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../developer/testing/metal3-dev-env.html"><strong aria-hidden="true">2.1.1.</strong> Metal³-Dev-Env</a></li><li class="chapter-item expanded "><a href="../../../developer/testing/tilt.html"><strong aria-hidden="true">2.1.2.</strong> Tilt</a></li></ol></li><li class="chapter-item expanded "><a href="../../../developer/contollers.html"><strong aria-hidden="true">2.2.</strong> Custom Resources</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../developer/controllers/Metal3Cluster.html"><strong aria-hidden="true">2.2.1.</strong> Metal3Cluster</a></li><li class="chapter-item expanded "><a href="../../../developer/controllers/Metal3Machine.html"><strong aria-hidden="true">2.2.2.</strong> Metal3Machine</a></li><li class="chapter-item expanded "><a href="../../../developer/controllers/BareMetalHost.html"><strong aria-hidden="true">2.2.3.</strong> BareMetalHost</a></li><li class="chapter-item expanded "><a href="../../../developer/controllers/Metal3MachineTemplate.html"><strong aria-hidden="true">2.2.4.</strong> Metal3MachineTemplate</a></li><li class="chapter-item expanded "><a href="../../../developer/controllers/IpPool.html"><strong aria-hidden="true">2.2.5.</strong> IpPool</a></li><li class="chapter-item expanded "><a href="../../../developer/controllers/IpClaim.html"><strong aria-hidden="true">2.2.6.</strong> IpClaim</a></li><li class="chapter-item expanded "><a href="../../../developer/controllers/IpAddress.html"><strong aria-hidden="true">2.2.7.</strong> IpAddress</a></li><li class="chapter-item expanded "><a href="../../../developer/controllers/Metal3Data.html"><strong aria-hidden="true">2.2.8.</strong> Metal3Data</a></li><li class="chapter-item expanded "><a href="../../../developer/controllers/Metal3DataClaim.html"><strong aria-hidden="true">2.2.9.</strong> Metal3DataClaim</a></li><li class="chapter-item expanded "><a href="../../../developer/controllers/Metal3DataTemplate.html"><strong aria-hidden="true">2.2.10.</strong> Metal3DataTemplate</a></li></ol></li><li class="chapter-item expanded "><a href="../../../developer/relational_diagram.html"><strong aria-hidden="true">2.3.</strong> Custom Resource Relational Diagram</a></li></ol></li><li class="chapter-item expanded "><a href="../../../references/references.html"><strong aria-hidden="true">3.</strong> References</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../references/glossary.html"><strong aria-hidden="true">3.1.</strong> Glossary</a></li><li class="chapter-item expanded "><a href="../../../references/code-of-conduct.html"><strong aria-hidden="true">3.2.</strong> Code of Conduct</a></li><li class="chapter-item expanded "><a href="../../../references/contribution.html"><strong aria-hidden="true">3.3.</strong> Contribution</a></li><li class="chapter-item expanded "><a href="../../../references/roadmap.html"><strong aria-hidden="true">3.4.</strong> Roadmap</a></li></ol></li><li class="chapter-item expanded "><a href="../../../mdbook.html"><strong aria-hidden="true">4.</strong> Multi-repo Test with Mdbook</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../submodules/bmo/docs/api.html"><strong aria-hidden="true">4.1.</strong> BMO</a></li><li class="chapter-item expanded "><a href="../../../submodules/capm3/docs/api.html" class="active"><strong aria-hidden="true">4.2.</strong> CAPM3</a></li><li class="chapter-item expanded "><a href="../../../submodules/dev-env/index.html"><strong aria-hidden="true">4.3.</strong> Metal3-dev-env</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Metal³ Book</h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        <a href="https://github.com/metal3-io" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#api-and-resource-definitions" id="api-and-resource-definitions">API and Resource Definitions</a></h1>
<p>This describes a setup where the following Cluster API core components and
Metal3-io components are deployed :</p>
<ul>
<li>Cluster API manager</li>
<li>Cluster API Bootstrap Provider Kubeadm (CABPK) manager</li>
<li>Cluster API Kubeadm Control Plane manager</li>
<li>Baremetal Operator (including the Ironic setup)</li>
<li>Cluster API Provider Metal3 (CAPM3)</li>
</ul>
<h2><a class="header" href="#baremetalhost" id="baremetalhost">BareMetalHost</a></h2>
<p>The BareMetalHost is an object from
<a href="https://github.com/metal3-io/baremetal-operator">baremetal-operator</a>. Each
CR represents a physical host with BMC credentials, hardware status etc.</p>
<p>BareMetalHost exposes those different fields that are secret references:</p>
<ul>
<li><strong>userData</strong> : for a cloud-init user-data in a secret with the key <code>userData</code></li>
<li><strong>metaData</strong> : for a cloud-init metadata in a secret with the key <code>metaData</code></li>
<li><strong>networkData</strong> : for a cloud-init network data in a secret with the key
<code>networkData</code></li>
</ul>
<p>For the metaData, soome values are set by default to maintain compatibility:</p>
<ul>
<li><strong>uuid</strong>: This is the BareMetalHost UID</li>
<li><strong>metal3-namespace</strong>: the name of the BareMetalHost</li>
<li><strong>metal3-name</strong>: The name of the BareMetalHost</li>
<li><strong>local-hostname</strong>: The name of the BareMetalHost</li>
<li><strong>local_hostname</strong>: The namespace of the BareMetalHost</li>
</ul>
<p>However, setting any of those values in the metaData secret will override those
default values.</p>
<h3><a class="header" href="#unhealthy-annotation" id="unhealthy-annotation">Unhealthy annotation</a></h3>
<p>In CAPM3 v1alpha4 it is possible to mark BareMetalHost object as unhealthy by adding an
annotation <code>capi.metal3.io/unhealthy</code>. This annotation prevents CAPM3 to select
unhealthy BareMetalHost for newly created metal3machine. Removing the annotation
will enable the normal operations.</p>
<h2><a class="header" href="#cluster" id="cluster">Cluster</a></h2>
<p>A Cluster is a Cluster API core object representing a Kubernetes cluster.</p>
<p>Example cluster:</p>
<pre><code class="language-yaml">apiVersion: cluster.x-k8s.io/v1alpha3
kind: Cluster
metadata:
  name: cluster
spec:
  clusterNetwork:
    services:
      cidrBlocks: [&quot;10.96.0.0/12&quot;]
    pods:
      cidrBlocks: [&quot;192.168.0.0/18&quot;]
    serviceDomain: &quot;cluster.local&quot;
  infrastructureRef:
    apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
    kind: Metal3Cluster
    name: m3cluster
  controlPlaneRef:
    kind: KubeadmControlPlane
    apiVersion: controlplane.cluster.x-k8s.io/v1alpha3
    name: m3cluster-controlplane
</code></pre>
<h2><a class="header" href="#metal3cluster" id="metal3cluster">Metal3Cluster</a></h2>
<p>The metal3Cluster object contains information related to the deployment of
the cluster on Baremetal. It currently has two specification fields :</p>
<ul>
<li><strong>controlPlaneEndpoint</strong>: contains the target cluster API server address and
port</li>
<li><strong>noCloudProvider</strong>: (true/false) Whether the cluster will not be deployed
with an external cloud provider. If set to true, CAPM3 will patch the target
cluster node objects to add a providerID. This will allow the CAPI process to
continue even if the cluster is deployed without cloud provider.</li>
</ul>
<p>Example metal3cluster :</p>
<pre><code class="language-yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
kind: Metal3Cluster
metadata:
  name: m3cluster
spec:
 controlPlaneEndpoint:
   host: 192.168.111.249
   port: 6443
 noCloudProvider: true
</code></pre>
<h2><a class="header" href="#kubeadmcontrolplane" id="kubeadmcontrolplane">KubeadmControlPlane</a></h2>
<p>This object contains all information related to the control plane configuration.
It references an <strong>infrastructureTemplate</strong> that must be a
<em>Metal3MachineTemplate</em> in this case.</p>
<p>For example:</p>
<pre><code class="language-yaml">kind: KubeadmControlPlane
apiVersion: controlplane.cluster.x-k8s.io/v1alpha3
metadata:
  name: m3cluster-controlplane
spec:
  replicas: 3
  version: v1.17.0
  infrastructureTemplate:
    kind: Metal3MachineTemplate
    apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
    name: m3cluster-controlplane
  kubeadmConfigSpec:
    initConfiguration:
      nodeRegistration:
        name: 'host0'
        kubeletExtraArgs:
          cloud-provider: baremetal
    clusterConfiguration:
      apiServer:
        extraArgs:
          cloud-provider: baremetal
      controllerManager:
        extraArgs:
          cloud-provider: baremetal
    joinConfiguration:
      controlPlane: {}
      nodeRegistration:
        name: 'host0'
        kubeletExtraArgs:
          cloud-provider: baremetal
</code></pre>
<h2><a class="header" href="#kubeadmconfig" id="kubeadmconfig">KubeadmConfig</a></h2>
<p>The KubeadmConfig object is for CABPK. It contains the node Kubeadm
configuration and additional commands to run on the node for the setup.</p>
<p>In order to deploy Kubernetes successfully, you need to know the cluster API
address before deployment. However, if you are deploying an HA cluster or if you
are deploying without using static ip addresses, the cluster API server address
is unknown. A solution to go around the problem is to deploy Keepalived.
Keepalived allows you to set up a virtual IP, defined beforehand, and shared
by the nodes. Hence the commands to set up Keepalived have to run before
kubeadm.</p>
<p>The content of a KubeadmConfig can contain Jinja2 template elements, since the
cloud-init renders the cloud-config as a Jinja2 template. It is possible to
use metadata from cloud-init, using the following: <code>{{ ds.meta_data.&lt;key&gt;}}</code>.
The keys and values are passed to cloud-init through a <code>Metal3DataTemplate</code>
object (see below).</p>
<p>Example KubeadmConfig:</p>
<pre><code class="language-yaml">apiVersion: bootstrap.cluster.x-k8s.io/v1alpha3
kind: KubeadmConfig
metadata:
  name: controlplane-0
spec:
  initConfiguration:
    nodeRegistration:
      name: '{{ ds.meta_data.name }}'
      kubeletExtraArgs:
        node-labels: 'metal3.io/uuid={{ ds.meta_data.uuid }}'
  preKubeadmCommands:
    - apt update -y
    - apt install net-tools -y
    - apt install -y gcc linux-headers-$(uname -r)
    - apt install -y keepalived
    - systemctl start keepalived
    - systemctl enable keepalived
    - &gt;-
      apt install apt-transport-https ca-certificates curl gnupg-agent
      software-properties-common -y
    - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
    - &gt;-
      add-apt-repository &quot;deb [arch=amd64]
      https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable&quot;
    - apt update -y
    - apt install docker-ce docker-ce-cli containerd.io -y
    - usermod -aG docker ubuntu
    - &gt;-
      curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg
      | apt-key add -
    - &gt;-
      echo 'deb https://apt.kubernetes.io/ kubernetes-xenial main'
      &gt; /etc/apt/sources.list.d/kubernetes.list
    - apt update
    - apt install -y kubelet kubeadm kubectl
    - systemctl enable --now kubelet
  postKubeadmCommands:
    - mkdir -p /home/ubuntu/.kube
    - cp /etc/kubernetes/admin.conf /home/ubuntu/.kube/config
    - chown ubuntu:ubuntu /home/ubuntu/.kube/config
  files:
      - path: /etc/keepalived/keepalived.conf
        content: |
          ! Configuration File for keepalived
          global_defs {
              notification_email {
              sysadmin@example.com
              support@example.com
              }
              notification_email_from lb@example.com
              smtp_server localhost
              smtp_connect_timeout 30
          }
          vrrp_instance VI_1 {
              state MASTER
              interface enp2s0
              virtual_router_id 1
              priority 101
              advert_int 1
              virtual_ipaddress {
                  192.168.111.249
              }
          }
</code></pre>
<h2><a class="header" href="#machine" id="machine">Machine</a></h2>
<p>A Machine is a Cluster API core object representing a Kubernetes node. A machine
has a reference to a KubeadmConfig and a reference to a metal3machine.</p>
<p>Example Machine:</p>
<pre><code class="language-yaml">apiVersion: cluster.x-k8s.io/v1alpha3
kind: Machine
metadata:
  name: controlplane-0
  labels:
    cluster.x-k8s.io/control-plane: &quot;true&quot;
    cluster.x-k8s.io/cluster-name: &quot;cluster&quot;
spec:
  version: 1.16
  bootstrap:
    configRef:
      apiVersion: bootstrap.cluster.x-k8s.io/v1alpha3
      kind: KubeadmConfig
      name: controlplane-0
  infrastructureRef:
    apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
    kind: Metal3Machine
    name: controlplane-0
</code></pre>
<h2><a class="header" href="#metal3machine" id="metal3machine">Metal3Machine</a></h2>
<p>The Metal3Machine contains information related to the deployment of the
BareMetalHost such as the image and the host selector. For each machine, there
must be a Metal3Machine.</p>
<p>The fields are :</p>
<ul>
<li>
<p><strong>image</strong> -- This includes two sub-fields, <code>url</code> and <code>checksum</code>, which
include the URL to the image and the URL to a checksum for that image. These
fields are required. The image will be used for provisioning of the
<code>BareMetalHost</code> chosen by the <code>Machine</code> actuator.</p>
</li>
<li>
<p><strong>userData</strong> -- This includes two sub-fields, <code>name</code> and <code>namespace</code>, which
reference a <code>Secret</code> that contains base64 encoded user-data to be written to
a config drive on the provisioned <code>BareMetalHost</code>. This field is optional and
is automatically set by CAPM3 with the userData from the machine object. If
you want to overwrite the userData, this should be done in the CAPI machine.</p>
</li>
<li>
<p><strong>dataTemplate</strong> -- This includes a reference to a Metal3DataTemplate object
containing the metadata and network data templates, and includes two fields,
<code>name</code> and <code>namespace</code>.</p>
</li>
<li>
<p><strong>metaData</strong> is a reference to a secret containing the metadata rendered from
the Metal3DataTemplate metadata template object automatically. In case this
would not be managed by the Metal3DataTemplate controller, if provided by the
user for example, the ownerreference should be set properly to ensure that the
secret belongs to the cluster ownerReference tree (see
<a href="https://cluster-api.sigs.k8s.io/clusterctl/provider-contract.html#ownerreferences-chain">doc</a>).</p>
</li>
<li>
<p><strong>networkData</strong> is a reference to a secret containing the network data
rendered from the Metal3DataTemplate metadata template object automatically.
In case this would not be managed by the Metal3DataTemplate controller, if
provided by the user for example, the ownerreference should be set properly to
ensure that the secret belongs to the cluster ownerReference tree (see
<a href="https://cluster-api.sigs.k8s.io/clusterctl/provider-contract.html#ownerreferences-chain">doc</a>).
The content of the secret should be a yaml equivalent of a json object that
follows the format definition that can be found
<a href="https://docs.openstack.org/nova/latest/_downloads/9119ca7ac90aa2990e762c08baea3a36/network_data.json">here</a>.</p>
</li>
<li>
<p><strong>hostSelector</strong> -- Specify criteria for matching labels on <code>BareMetalHost</code>
objects. This can be used to limit the set of available <code>BareMetalHost</code>
objects chosen for this <code>Machine</code>.</p>
</li>
</ul>
<p>The <code>metaData</code> and <code>networkData</code> field in the <code>spec</code> section are for the user
to give directly a secret to use as metaData or networkData. The <code>userData</code>,
<code>metaData</code> and <code>networkData</code> fields in the <code>status</code> section are for the
controller to store the reference to the secret that is actually being used,
whether it is from one of the spec fields, or somehow generated. This is aimed
at making a clear difference between the desired state from the user (whether
it is with a DataTemplate reference, or direct <code>metaData</code> or <code>userData</code> secrets)
and what the controller is actually using.</p>
<p>The <code>dataTemplate</code> field consists of an object reference to a
Metal3DataTemplate object containing the templates for the metadata and
network data generation for this Metal3Machine. The <code>renderedData</code> field is a
reference to the Metal3Data object created for this machine. If the
dataTemplate field is set but either the <code>renderedData</code>, <code>metaData</code> or
<code>networkData</code> fields in the status are unset, then the Metal3Machine
controller will wait until it can find the Metal3Data object and the rendered
secrets. It will then populate those fields.</p>
<p>When CAPM3 controller will set the different fields in the BareMetalHost,
it will reference the metadata secret and the network data secret
in the BareMetalHost. If any of the <code>metaData</code> or <code>networkData</code> status fields
are unset, that field will also remain unset on the BareMetalHost.</p>
<p>When the Metal3Machine gets deleted, the CAPM3 controller will remove its
ownerreference from the data template object. This will trigger the deletion of
the generated Metal3Data object and the secrets generated for this machine.</p>
<h3><a class="header" href="#hostselector-examples" id="hostselector-examples">hostSelector Examples</a></h3>
<p>The `hostSelector field has two possible optional sub-fields:</p>
<ul>
<li>
<p><strong>matchLabels</strong> -- Key/value pairs of labels that must match exactly.</p>
</li>
<li>
<p><strong>matchExpressions</strong> -- A set of expressions that must evaluate to true for
the labels on a <code>BareMetalHost</code>.</p>
</li>
</ul>
<p>Valid operators include:</p>
<ul>
<li><strong>!</strong> -- Key does not exist. Values ignored.</li>
<li><strong>=</strong> -- Key equals specified value. There must only be one
value specified.</li>
<li><strong>==</strong> -- Key equals specified value. There must only be one
value specified.</li>
<li><strong>in</strong> -- Value is a member of a set of possible values</li>
<li><strong>!=</strong> -- Key does not equal the specified value. There must
only be one value specified.</li>
<li><strong>notin</strong> -- Value not a member of the specified set of values.</li>
<li><strong>exists</strong> -- Key exists. Values ignored.</li>
<li><strong>gt</strong> -- Value is greater than the one specified. Value must be
an integer.</li>
<li><strong>lt</strong> -- Value is less than the one specified. Value must be
an integer.</li>
</ul>
<p>Example 1: Only consider a <code>BareMetalHost</code> with label <code>key1</code> set to <code>value1</code>.</p>
<pre><code class="language-yaml">spec:
  providerSpec:
    value:
      hostSelector:
        matchLabels:
          key1: value1
</code></pre>
<p>Example 2: Only consider <code>BareMetalHost</code> with both <code>key1</code> set to <code>value1</code> AND
<code>key2</code> set to <code>value2</code>.</p>
<pre><code class="language-yaml">spec:
  providerSpec:
    value:
      hostSelector:
        matchLabels:
          key1: value1
          key2: value2
</code></pre>
<p>Example 3: Only consider <code>BareMetalHost</code> with <code>key3</code> set to either <code>a</code>, <code>b</code>, or
<code>c</code>.</p>
<pre><code class="language-yaml">spec:
  providerSpec:
    value:
      hostSelector:
        matchExpressions:
          - key: key3
            operator: in
            values: [‘a’, ‘b’, ‘c’]
</code></pre>
<p>Example 3: Only consider <code>BareMetalHost</code> with <code>key1</code> set to <code>value1</code> AND <code>key2</code>
set to <code>value2</code> AND <code>key3</code> set to either <code>a</code>, <code>b</code>, or <code>c</code>.</p>
<pre><code class="language-yaml">spec:
  providerSpec:
    value:
      hostSelector:
        matchLabels:
          key1: value1
          key2: value2
        matchExpressions:
          - key: key3
            operator: in
            values: [‘a’, ‘b’, ‘c’]
</code></pre>
<h3><a class="header" href="#metal3machine-example" id="metal3machine-example">Metal3Machine example</a></h3>
<pre><code class="language-yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
kind: Metal3Machine
metadata:
  name: controlplane-0
spec:
  image:
    url: https://cloud-images.ubuntu.com/bionic/current/bionic-server-cloudimg-amd64.img
    checksum: https://cloud-images.ubuntu.com/bionic/current/bionic-server-cloudimg-amd64.img.md5sum
  hostSelector:
    matchLabels:
      key1: value1
    matchExpressions:
      key: key2
      operator: in
      values: {‘abc’, ‘123’, ‘value2’}
  dataTemplate:
    Name: controlplane-metadata
  metaData:
    Name: controlplane-0-metadata-0
</code></pre>
<h2><a class="header" href="#machinedeployment" id="machinedeployment">MachineDeployment</a></h2>
<p>MachineDeployment is a core Cluster API object that is similar to
deployment for pods. It refers to a KubeadmConfigTemplate and to a
Metal3MachineTemplate.</p>
<p>Example MachineDeployment:</p>
<pre><code class="language-yaml">apiVersion: cluster.x-k8s.io/v1alpha3
kind: MachineDeployment
metadata:
  name: md-0
  labels:
    cluster.x-k8s.io/cluster-name: cluster
    nodepool: nodepool-0
spec:
  replicas: 1
  selector:
    matchLabels:
      cluster.x-k8s.io/cluster-name: cluster
      nodepool: nodepool-0
  template:
    metadata:
      labels:
        cluster.x-k8s.io/cluster-name: cluster
        nodepool: nodepool-0
    spec:
      version: 1.16
      bootstrap:
        configRef:
          name: md-0
          apiVersion: bootstrap.cluster.x-k8s.io/v1alpha3
          kind: KubeadmConfigTemplate
      infrastructureRef:
        name: md-0
        apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
        kind: Metal3MachineTemplate
</code></pre>
<h2><a class="header" href="#kubeadmconfigtemplate" id="kubeadmconfigtemplate">KubeadmConfigTemplate</a></h2>
<p>This contains a template to generate KubeadmConfig.</p>
<p>Example KubeadmConfigTemplate:</p>
<pre><code class="language-yaml">apiVersion: bootstrap.cluster.x-k8s.io/v1alpha3
kind: KubeadmConfigTemplate
metadata:
  name: md-0
spec:
  template:
    spec:
      joinConfiguration:
        nodeRegistration:
          name: '{{ ds.meta_data.name }}'
          kubeletExtraArgs:
            node-labels: 'metal3.io/uuid={{ ds.meta_data.uuid }}'
      preKubeadmCommands:
        - apt update -y
        - &gt;-
          apt install apt-transport-https ca-certificates curl gnupg-agent
          software-properties-common -y
        - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
        - &gt;-
          add-apt-repository &quot;deb [arch=amd64]
          https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable&quot;
        - apt update -y
        - apt install docker-ce docker-ce-cli containerd.io -y
        - usermod -aG docker ubuntu
        - &gt;-
          curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg
          | apt-key add -
        - &gt;-
          echo 'deb https://apt.kubernetes.io/ kubernetes-xenial main'
          &gt; /etc/apt/sources.list.d/kubernetes.list
        - apt update
        - apt install -y kubelet kubeadm kubectl
        - systemctl enable --now kubelet
</code></pre>
<h2><a class="header" href="#metal3machinetemplate" id="metal3machinetemplate">Metal3MachineTemplate</a></h2>
<p>The Metal3MachineTemplate contains the template to create Metal3Machine.</p>
<p>Example Metal3MachineTemplate :</p>
<pre><code class="language-yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
kind: Metal3MachineTemplate
metadata:
  name: md-0
spec:
  template:
    spec:
      image:
        url: https://cloud-images.ubuntu.com/bionic/current/bionic-server-cloudimg-amd64.img
        checksum: https://cloud-images.ubuntu.com/bionic/current/bionic-server-cloudimg-amd64.img.md5sum
      hostSelector:
        matchLabels:
          key1: value1
        matchExpressions:
          key: key2
          operator: in
          values: {‘abc’, ‘123’, ‘value2’}
      dataTemplate:
        Name: md-0-metadata
</code></pre>
<h2><a class="header" href="#metal3datatemplate" id="metal3datatemplate">Metal3DataTemplate</a></h2>
<pre><code class="language-yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
kind: Metal3DataTemplate
metadata:
  name: nodepool-1
  namespace: default
  ownerReferences:
  - apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
    controller: true
    kind: Metal3Cluster
    name: cluster-1
spec:
  metaData:
    strings:
      - key: abc
        value: def
    objectNames:
      - key: name_m3m
        object: metal3machine
      - key: name_machine
        object: machine
      - key: name_bmh
        object: baremetalhost
    indexes:
      - key: index
        offset: 0
        step: 1
    ipAddressesFromIPPool:
      - key: ip
        Name: pool-1
    prefixesFromIPPool:
      - key: ip
        Name: pool-1
    gatewaysFromIPPool:
      - key: gateway
        Name: pool-1
    dnsServersFromIPPool:
      - key: dns
        Name: pool-1
    fromHostInterfaces:
      - key: mac
        interface: &quot;eth0&quot;
    fromLabels:
      - key: label-1
        object: machine
        label: mylabelkey
    fromAnnotations:
      - key: annotation-1
        object: machine
        annotation: myannotationkey
  networkData:
    links:
      ethernets:
        - type: &quot;phy&quot;
          id: &quot;enp1s0&quot;
          mtu: 1500
          macAddress:
            fromHostInterface: &quot;eth0&quot;
        - type: &quot;phy&quot;
          id: &quot;enp2s0&quot;
          mtu: 1500
          macAddress:
            fromHostInterface: &quot;eth1&quot;
      bonds:
        - id: &quot;bond0&quot;
          mtu: 1500
          macAddress:
            string: &quot;XX:XX:XX:XX:XX:XX&quot;
          bondMode: &quot;802.1ad&quot;
          bondLinks:
            - enp1s0
            - enp2s0
      vlans:
        - id: &quot;vlan1&quot;
          mtu: 1500
          macAddress:
            string: &quot;YY:YY:YY:YY:YY:YY&quot;
          vlanId: 1
          vlanLink: bond0
    networks:
      ipv4DHCP:
        - id: &quot;provisioning&quot;
          link: &quot;bond0&quot;

      ipv4:
        - id: &quot;Baremetal&quot;
          link: &quot;vlan1&quot;
          IPAddressFromIPPool: pool-1
          routes:
            - network: &quot;0.0.0.0&quot;
              netmask: 0
              gateway:
                fromIPPool: pool-1
              services:
                dns:
                  - &quot;8.8.4.4&quot;
                dnsFromIPPool: pool-1
      ipv6DHCP:
        - id: &quot;provisioning6&quot;
          link: &quot;bond0&quot;
      ipv6SLAAC:
        - id: &quot;provisioning6slaac&quot;
          link: &quot;bond0&quot;
      ipv6:
        - id: &quot;Baremetal6&quot;
          link: &quot;vlan1&quot;
          IPAddressFromIPPool: pool6-1
          routes:
            - network: &quot;0::0&quot;
              netmask: 0
              gateway:
                string: &quot;2001:0db8:85a3::8a2e:0370:1&quot;
              services:
                dns:
                  - &quot;2001:4860:4860::8844&quot;
                dnsFromIPPool: pool6-1
    services:
      dns:
        - &quot;8.8.8.8&quot;
        - &quot;2001:4860:4860::8888&quot;
status:
  indexes:
    &quot;0&quot;: &quot;machine-1&quot;
  dataNames:
    &quot;machine-1&quot;: nodepool-1-0
  lastUpdated: &quot;2020-04-02T06:36:09Z&quot;
</code></pre>
<p>This object will be reconciled by its own controller. When reconciled,
the controller will add a label pointing to the Metal3Cluster that has nodes
linking to this object. The spec contains a <code>metaData</code> and a <code>networkData</code> field
that contain a template of the values that will be rendered for all nodes.</p>
<p>The <code>metaData</code> field will be rendered into a map of strings in yaml format,
while <code>networkData</code> will be rendered into a map equivalent of
<a href="https://docs.openstack.org/nova/latest/user/metadata.html#openstack-format-metadata">Nova network_data.json</a>.
On the target node, the network data will be rendered as a json object that
follows the format definition that can be found
<a href="https://docs.openstack.org/nova/latest/_downloads/9119ca7ac90aa2990e762c08baea3a36/network_data.json">here</a>.</p>
<h3><a class="header" href="#metadata-specifications" id="metadata-specifications">Metadata Specifications</a></h3>
<p>The <code>metaData</code> field contains a list of items that will render data in different
ways. The following types of objects are available and accept lists:</p>
<ul>
<li><strong>strings</strong>: renders the given string as value in the metadata. It takes a
<code>value</code> attribute.</li>
<li><strong>objectNames</strong> : renders the name of the object that matches the type given.
It takes an <code>object</code> attribute, containing the type of the object.</li>
<li><strong>indexes</strong>: renders the index of the current object, with the offset from the
<code>offset</code> field and using the step from the <code>step</code> field. The following
conditions must be matched : <code>offset</code> &gt;= 0 and <code>step</code> &gt;= 1
if the step is unspecified (default value being 0), the controller will
automatically change it for 1. The <code>prefix</code> and <code>suffix</code> attributes are to
provide a prefix and a suffix for the rendered index.</li>
<li><strong>ipAddressesFromIPPool</strong>: renders an ip address from an <em>IPPool</em>
object. The <em>IPPool</em> objects are defined in the
<a href="https://github.com/metal3-io/ip-address-manager">IP Address manager repo</a></li>
<li><strong>prefixesFromIPPool</strong>: renders a network prefix from an <em>IPPool</em>
object. The <em>IPPool</em> objects are defined in the
<a href="https://github.com/metal3-io/ip-address-manager">IP Address manager repo</a></li>
<li><strong>gatewaysFromIPPool</strong>: renders a network gateway from an <em>IPPool</em>
object. The <em>IPPool</em> objects are defined in the
<a href="https://github.com/metal3-io/ip-address-manager">IP Address manager repo</a></li>
<li><strong>dnsServersFromIPPool</strong>: renders a dns servers list from an <em>IPPool</em>
object. The <em>IPPool</em> objects are defined in the
<a href="https://github.com/metal3-io/ip-address-manager">IP Address manager repo</a></li>
<li><strong>fromHostInterfaces</strong>: renders the MAC address of the BareMetalHost that
matches the name given as value.</li>
<li><strong>fromLabels</strong>: renders the content of a label on an object or an empty string
if the label is absent. It takes an <code>object</code> attribute to specify the type of
the object where to fetch the label, and a <code>label</code> attribute that contains the
label key.</li>
<li><strong>fromAnnotations</strong>: renders the content of a annotation on an object or an
empty string if the annotation is absent. It takes an <code>object</code> attribute to
specify the type of the object where to fetch the annotation, and an
<code>annotation</code> attribute that contains the annotation key.</li>
</ul>
<p>For each object, the attribute <strong>key</strong> is required.</p>
<h3><a class="header" href="#networkdata-specifications" id="networkdata-specifications">networkData specifications</a></h3>
<p>The <code>networkData</code> field will contain three items :</p>
<ul>
<li><strong>links</strong>: a list of layer 2 interface</li>
<li><strong>networks</strong>: a list of layer 3 networks</li>
<li><strong>services</strong> : a list of services (DNS)</li>
</ul>
<h4><a class="header" href="#links-specifications" id="links-specifications">Links specifications</a></h4>
<p>The object for the <strong>links</strong> section list can be:</p>
<ul>
<li><strong>ethernets</strong>: a list of ethernet interfaces</li>
<li><strong>bonds</strong>: a list of bond interfaces</li>
<li><strong>vlans</strong>: a list of vlan interfaces</li>
</ul>
<p>The <strong>links/ethernets</strong> objects contain the following:</p>
<ul>
<li><strong>type</strong>: Type of the ethernet interface</li>
<li><strong>id</strong>: Interface name</li>
<li><strong>mtu</strong>: Interface MTU</li>
<li><strong>macAddress</strong>: an object to render the MAC Address</li>
</ul>
<p>The <strong>links/ethernets/type</strong> can be one of :</p>
<ul>
<li>bridge</li>
<li>dvs</li>
<li>hw_veb</li>
<li>hyperv</li>
<li>ovs</li>
<li>tap</li>
<li>vhostuser</li>
<li>vif</li>
<li>phy</li>
</ul>
<p>The <strong>links/ethernets/macAddress</strong> object can be one of:</p>
<ul>
<li><strong>string</strong>: with the desired Mac given as a string</li>
<li><strong>fromHostInterface</strong>: with the interface name from BareMetalHost
hardware details.</li>
</ul>
<p>The <strong>links/bonds</strong> object contains the following:</p>
<ul>
<li><strong>id</strong>: Interface name</li>
<li><strong>mtu</strong>: Interface MTU</li>
<li><strong>macAddress</strong>: an object to render the MAC Address</li>
<li><strong>bondMode</strong>: The bond mode</li>
<li><strong>bondLinks</strong> : a list of links to use for the bond</li>
</ul>
<p>The <strong>links/bonds/bondMode</strong> can be one of :</p>
<ul>
<li>802.1ad</li>
<li>balance-rr</li>
<li>active-backup</li>
<li>balance-xor</li>
<li>broadcast</li>
<li>balance-tlb</li>
<li>balance-alb</li>
</ul>
<p>The <strong>links/vlans</strong> object contains the following:</p>
<ul>
<li><strong>id</strong>: Interface name</li>
<li><strong>mtu</strong>: Interface MTU</li>
<li><strong>macAddress</strong>: an object to render the MAC Address</li>
<li><strong>vlanId</strong>: The vlan ID</li>
<li><strong>vlanLink</strong> : The link on which to create the vlan</li>
</ul>
<h4><a class="header" href="#the-networks-specifications" id="the-networks-specifications">The networks specifications</a></h4>
<p>The object for the <strong>networks</strong> section can be:</p>
<ul>
<li><strong>ipv4</strong>: a list of ipv4 static allocations</li>
<li><strong>ipv4DHCP</strong>: a list of ipv4 DHCP based allocations</li>
<li><strong>ipv6</strong>: a list of ipv6 static allocations</li>
<li><strong>ipv6DHCP</strong>: a list of ipv6 DHCP based allocations</li>
<li><strong>ipv6SLAAC</strong>: a list of ipv6 SLAAC based allocations</li>
</ul>
<p>The <strong>networks/ipv4</strong> object contains the following:</p>
<ul>
<li><strong>id</strong>: the network name</li>
<li><strong>link</strong>: The name of the link to configure this network for</li>
<li><strong>ipAddressFromIPPool</strong>: renders an ip address from an <em>IPPool</em>
object. The <em>IPPool</em> objects are defined in the
<a href="https://github.com/metal3-io/ip-address-manager">IP Address manager repo</a></li>
<li><strong>routes</strong>: the list of route objects</li>
</ul>
<p>The <em><em>networks/ipv</em>/routes</em>* is a route object containing:</p>
<ul>
<li><strong>network</strong>: the subnet to reach</li>
<li><strong>netmask</strong>: the mask of the subnet as integer</li>
<li><strong>gateway</strong>: the gateway to use, it can either be given as a string in
<em>string</em> or as an IPPool name in <em>fromIPPool</em></li>
<li><strong>services</strong>: a list of services object as defined later</li>
</ul>
<p>The <strong>networks/ipv4Dhcp</strong> object contains the following:</p>
<ul>
<li><strong>id</strong>: the network name</li>
<li><strong>link</strong>: The name of the link to configure this network for</li>
<li><strong>routes</strong>: the list of route objects</li>
</ul>
<p>The <strong>networks/ipv6</strong> object contains the following:</p>
<ul>
<li><strong>id</strong>: the network name</li>
<li><strong>link</strong>: The name of the link to configure this network for</li>
<li><strong>ipAddressFromIPPool</strong>: renders an ip address from an <em>IPPool</em>
object. The <em>IPPool</em> objects are defined in the
<a href="https://github.com/metal3-io/ip-address-manager">IP Address manager repo</a></li>
<li><strong>routes</strong>: the list of route objects</li>
</ul>
<p>The <strong>networks/ipv6Dhcp</strong> object contains the following:</p>
<ul>
<li><strong>id</strong>: the network name</li>
<li><strong>link</strong>: The name of the link to configure this network for</li>
<li><strong>routes</strong>: the list of route objects</li>
</ul>
<p>The <strong>networks/ipv6Slaac</strong> object contains the following:</p>
<ul>
<li><strong>id</strong>: the network name</li>
<li><strong>link</strong>: The name of the link to configure this network for</li>
<li><strong>routes</strong>: the list of route objects</li>
</ul>
<h4><a class="header" href="#the-services-specifications" id="the-services-specifications">the services specifications</a></h4>
<p>The object for the <strong>services</strong> section can be:</p>
<ul>
<li><strong>dns</strong>: a list of dns service with the ip address of a dns server</li>
<li><strong>dnsFromIPPool</strong>: the IPPool from which to fetch the dns servers list</li>
</ul>
<h2><a class="header" href="#the-metal3dataclaim-object" id="the-metal3dataclaim-object">The Metal3DataClaim object</a></h2>
<p>A new object would be created, a Metal3DataClaim type.</p>
<pre><code class="language-yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
kind: Metal3DataClaim
metadata:
  name: machine-1
  namespace: default
  ownerReferences:
  - apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
    controller: true
    kind: Metal3Machine
    name: machine-1
spec:
  template:
    name: nodepool-1
status:
  renderedData:
    name: nodepool-1-0
  errorMessage: &quot;&quot;
</code></pre>
<p>The <em>Metal3DataClaim</em> object will reference its target <em>Metal3DataTemplate</em>
object. In its status, the <em>renderedData</em> would reference the <em>Metal3Data</em>
object when it would be generated. In case of error, the <em>errorMessage</em> would
contain a description of the error.</p>
<h2><a class="header" href="#the-metal3data-object" id="the-metal3data-object">The Metal3Data object</a></h2>
<p>The output of the controller would be a Metal3Data object,one per node linking to the
Metal3DataTemplate object and the associated secrets</p>
<p>The Metal3Data object would be:</p>
<pre><code class="language-yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
kind: Metal3Data
metadata:
  name: nodepool-1-0
  namespace: default
  ownerReferences:
  - apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
    controller: true
    kind: Metal3DataTemplate
    name: nodepool-1
spec:
  index: 0
  metaData:
    name: machine-1-metadata
    namespace: default
  networkData:
    name: machine-1-metadata
    namespace: default
  metal3Machine:
    name: machine-1
    namespace: default
status:
  ready: true
  error: false
  errorMessage: &quot;&quot;
</code></pre>
<p>The Metal3Data will contain the index of this node, and links to the secrets
generated and to the Metal3Machine using this Metal3Data object.</p>
<p>If the Metal3DataTemplate object is updated, the generated secrets will not be
updated, to allow for reprovisioning of the nodes in the exact same state as
they were initially provisioned. Hence, to do an update, it is necessary to do
a rolling upgrade of all nodes.</p>
<p>The reconciliation of the Metal3DataTemplate object will also be triggered by
changes on Metal3Machines. In the case that a Metal3Machine gets modified, if
the <code>dataTemplate</code> references a Metal3DataTemplate, that <em>Metal3DataClaim</em>
object will be reconciled. There will be two cases:</p>
<ul>
<li>An already generated Metal3Data object exists for that <em>Metal3DataClaim</em>. If
the reference is not in the <em>Metal3DataClaim</em> object, the reconciler will add
it. The reconciler will also verify that the required secrets exist. If they
do not, they will be created.</li>
<li>if no Metal3Data exists for that <em>Metal3DataClaim</em>, then the
reconciler will create one and fill the respective field with the secret name.</li>
</ul>
<p>To create a Metal3Data object, the <em>Metal3DataClaim</em> controller will select an
index for that Metal3Machine. The selection happens by selecting the lowest
available index that is not in use. To do that, the controller will list all
existing Metal3Data object linked to this Metal3DataTemplate and to get the
unavailable indexes. The indexes always start from 0 and increment by 1. The
lowest available index is to be used next. The <code>dataNames</code> field contains the
map of Metal3Machine to Metal3Data and the <code>indexes</code> contains the map of
allocated indexes and claims.</p>
<p>Once the next lowest available index is found, it will create the Metal3Data
object. The name would be a concatenation of the Metal3DataTemplate name and
index. Upon conflict, it will fetch again the list to consider the new list of
Metal3Data and try to create the new object with the new index, this will happen
until the new object is created successfully. Upon success, it will render the
content values, and create the secrets containing the rendered data. The
controller will generate the content based on the <code>metaData</code> or <code>networkData</code>
field of the Metal3DataTemplate Specs. The <em>ready</em> field in <em>renderedData</em> will
then be set accordingly. If any error happens during the rendering, an error
message will be added.</p>
<h3><a class="header" href="#the-generated-secrets" id="the-generated-secrets">The generated secrets</a></h3>
<p>The name of the secret will be made of a prefix and the index. The Metal3Machine
object name will be used as the prefix. A <code>-metadata-</code> or <code>-networkdata-</code> will
be added between the prefix and the index.</p>
<h2><a class="header" href="#deployment-flow" id="deployment-flow">Deployment flow</a></h2>
<h3><a class="header" href="#manual-secret-creation" id="manual-secret-creation">Manual secret creation</a></h3>
<p>In the case where the Metal3Machine is created without a <code>dataTemplate</code> value,
if the <code>metaData</code> or <code>networkData</code> fields are set (one or both), the
Metal3Machine reconciler will fetch the secret, set the status field and
directly start the provisioning of the BareMetalHost using the secrets if given.
If one of the secrets does not exist, the controller will wait to start the
provisioning of the BareMetalHost until it exists.</p>
<h3><a class="header" href="#dynamic-secret-creation" id="dynamic-secret-creation">Dynamic secret creation</a></h3>
<p>In the case where the Metal3Machine is created with a <code>dataTemplate</code> value, the
Metal3Machine reconciler will create a <em>Metal3DataClaim</em> for that object.</p>
<p>The <em>Metal3DataClaim</em> would then be reconciled, and its controller will create
an index for this <em>Metal3DataClaim</em> if it does not exist yet, and create a
Metal3Data object with the index. Upon success, it will set the <em>ready</em> field
to true, and the <em>renderedData</em> field to reference the <em>Metal3Data</em> object.</p>
<p>The Metal3Data reconciler will then generate the secrets, based on the index,
the Metal3DataTemplate and the machine. Once created, it will set the status
field <code>ready</code> to True.</p>
<p>Once the Metal3Data object is ready, the Metal3Machine controller will fetch
the secrets that have been created (one or both) and use them to start
provisioning the BareMetalHost.</p>
<h3><a class="header" href="#hybrid-configuration" id="hybrid-configuration">Hybrid configuration</a></h3>
<p>If the Metal3Machine object is created with a <code>dataTemplate</code> field set, but one
of the <code>metaData</code> or <code>networkData</code> is also set in the spec, this one will
override the template generation for this specific secret. i.e. if the user sets
the three fields, the controller will use the user input secret for both.</p>
<p>This means that some hybrid scenarios are supported, where the user can give
directly the <code>metaData</code> secret and let the controller render the <code>networkData</code>
secret through the Metal3DataTemplate object.</p>
<h2><a class="header" href="#metal3-dev-env-examples" id="metal3-dev-env-examples">Metal3 dev env examples</a></h2>
<p>You can find CR examples in the
<a href="https://github.com/metal3-io/metal3-dev-env">Metal3-io dev env project</a>,
in the <a href="https://github.com/metal3-io/metal3-dev-env/tree/master/vm-setup/roles/v1aX_integration_test/templates">template
folder</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../../submodules/bmo/docs/api.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../../submodules/dev-env/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../../submodules/bmo/docs/api.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../../submodules/dev-env/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
