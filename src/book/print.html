<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Metal³ Book</title>
        
        <meta name="robots" content="noindex" />
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="overview/project-overview.html"><strong aria-hidden="true">1.</strong> Project Overview</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="overview/metal3-components.html"><strong aria-hidden="true">1.1.</strong> Metal³ Components</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="overview/capm3/capm3.html"><strong aria-hidden="true">1.1.1.</strong> Cluster-Api-Provider-Metal³</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="overview/capm3/workflow.html"><strong aria-hidden="true">1.1.1.1.</strong> Workflow</a></li><li class="chapter-item expanded "><a href="overview/capm3/api.html"><strong aria-hidden="true">1.1.1.2.</strong> API concepts</a></li></ol></li><li class="chapter-item expanded "><a href="overview/bmo/bmo.html"><strong aria-hidden="true">1.1.2.</strong> Baremetal Operator</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="overview/bmo/ironic-integration.html"><strong aria-hidden="true">1.1.2.1.</strong> Ironic Integration</a></li><li class="chapter-item expanded "><a href="overview/bmo/bmh-states.html"><strong aria-hidden="true">1.1.2.2.</strong> BaremetalHost Provisioning States</a></li><li class="chapter-item expanded "><a href="overview/bmo/workflow.html"><strong aria-hidden="true">1.1.2.3.</strong> Workflow</a></li><li class="chapter-item expanded "><a href="overview/bmo/api.html"><strong aria-hidden="true">1.1.2.4.</strong> API concepts</a></li></ol></li><li class="chapter-item expanded "><a href="overview/metal3-dev-env.html"><strong aria-hidden="true">1.1.3.</strong> Metal³-Dev-Env</a></li><li class="chapter-item expanded "><a href="overview/ipam/ip-address-manager.html"><strong aria-hidden="true">1.1.4.</strong> Ip-Address-Manager</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="overview/ipam/workflow.html"><strong aria-hidden="true">1.1.4.1.</strong> Workflow</a></li><li class="chapter-item expanded "><a href="overview/ipam/api.html"><strong aria-hidden="true">1.1.4.2.</strong> API concepts</a></li></ol></li></ol></li></ol></li><li class="chapter-item expanded "><a href="developer/developer-guide.html"><strong aria-hidden="true">2.</strong> Developer Guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="developer/testing.html"><strong aria-hidden="true">2.1.</strong> Testing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="developer/testing/metal3-dev-env.html"><strong aria-hidden="true">2.1.1.</strong> Metal³-Dev-Env</a></li><li class="chapter-item expanded "><a href="developer/testing/tilt.html"><strong aria-hidden="true">2.1.2.</strong> Tilt</a></li></ol></li><li class="chapter-item expanded "><a href="developer/contollers.html"><strong aria-hidden="true">2.2.</strong> Custom Resources</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="developer/controllers/Metal3Cluster.html"><strong aria-hidden="true">2.2.1.</strong> Metal3Cluster</a></li><li class="chapter-item expanded "><a href="developer/controllers/Metal3Machine.html"><strong aria-hidden="true">2.2.2.</strong> Metal3Machine</a></li><li class="chapter-item expanded "><a href="developer/controllers/BareMetalHost.html"><strong aria-hidden="true">2.2.3.</strong> BareMetalHost</a></li><li class="chapter-item expanded "><a href="developer/controllers/Metal3MachineTemplate.html"><strong aria-hidden="true">2.2.4.</strong> Metal3MachineTemplate</a></li><li class="chapter-item expanded "><a href="developer/controllers/IpPool.html"><strong aria-hidden="true">2.2.5.</strong> IpPool</a></li><li class="chapter-item expanded "><a href="developer/controllers/IpClaim.html"><strong aria-hidden="true">2.2.6.</strong> IpClaim</a></li><li class="chapter-item expanded "><a href="developer/controllers/IpAddress.html"><strong aria-hidden="true">2.2.7.</strong> IpAddress</a></li><li class="chapter-item expanded "><a href="developer/controllers/Metal3Data.html"><strong aria-hidden="true">2.2.8.</strong> Metal3Data</a></li><li class="chapter-item expanded "><a href="developer/controllers/Metal3DataClaim.html"><strong aria-hidden="true">2.2.9.</strong> Metal3DataClaim</a></li><li class="chapter-item expanded "><a href="developer/controllers/Metal3DataTemplate.html"><strong aria-hidden="true">2.2.10.</strong> Metal3DataTemplate</a></li></ol></li><li class="chapter-item expanded "><a href="developer/relational_diagram.html"><strong aria-hidden="true">2.3.</strong> Custom Resource Relational Diagram</a></li></ol></li><li class="chapter-item expanded "><a href="references/references.html"><strong aria-hidden="true">3.</strong> References</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="references/glossary.html"><strong aria-hidden="true">3.1.</strong> Glossary</a></li><li class="chapter-item expanded "><a href="references/code-of-conduct.html"><strong aria-hidden="true">3.2.</strong> Code of Conduct</a></li><li class="chapter-item expanded "><a href="references/contribution.html"><strong aria-hidden="true">3.3.</strong> Contribution</a></li><li class="chapter-item expanded "><a href="references/roadmap.html"><strong aria-hidden="true">3.4.</strong> Roadmap</a></li></ol></li><li class="chapter-item expanded "><a href="mdbook.html"><strong aria-hidden="true">4.</strong> Multi-repo Test with Mdbook</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="submodules/bmo/docs/api.html"><strong aria-hidden="true">4.1.</strong> BMO</a></li><li class="chapter-item expanded "><a href="submodules/capm3/docs/api.html"><strong aria-hidden="true">4.2.</strong> CAPM3</a></li><li class="chapter-item expanded "><a href="submodules/dev-env/index.html"><strong aria-hidden="true">4.3.</strong> Metal3-dev-env</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Metal³ Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        <a href="https://github.com/metal3-io" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#metal³div-stylefloat-right-position-relative-display-inlineimg-srcimagesmetal3-website-stickerpng-width160px-div" id="metal³div-stylefloat-right-position-relative-display-inlineimg-srcimagesmetal3-website-stickerpng-width160px-div">Metal³<div style="float: right; position: relative; display: inline;"><img src="images/metal3-website-sticker.png" width="160px" /></div></a></h1>
<p>Metal³ project (pronounced: Metal Kubed) exists to provide components
that allow you to do bare metal host management for Kubernetes. Metal³
works as a Kubernetes application, meaning it runs on Kubernetes and is
managed through Kubernetes interfaces.</p>
<p>Metal³ is one of the providers for the Kubernetes sub-project Cluster
API and is focused on providing Kubernetes native APIs to manage
Kubernetes clusters in a bare metal environment.</p>
<h2><a class="header" href="#community" id="community">Community</a></h2>
<p>Metal³ is constantly being improved thanks to the users, contributors
and maintainers, and we very much welcome any contribution to the project.
Please see the contribution guide for more details on how to get started
contributing to the project.</p>
<p>You can reach community members via:</p>
<ul>
<li>Metal³ Development <a href="https://groups.google.com/forum/#!forum/metal3-dev">Mailing List</a></li>
<li><a href="https://kubernetes.slack.com/messages/CHD49TLE7">#cluster-api-baremetal</a>
on Kubernetes Slack</li>
<li>Bi-Weekly Community Meetings every alternate Wednesday at 13:00 UTC on
<a href="https://teams.microsoft.com/l/meetup-join/19%3ameeting_Nzg3MzQwMjUtOTI1Yi00ZTNhLWI3ZDktZmRkNTQ4NDgxY2E1%40thread.v2/0?context=%7b%22Tid%22%3a%22d2585e63-66b9-44b6-a76e-4f4b217d97fd%22%2c%22Oid%22%3a%22456f342b-7f3c-4825-abcd-e095f00cd654%22%7d">Microsoft Teams</a></li>
<li>Meetings: [ <a href="https://docs.google.com/document/d/1d7jqIgmKHvOdcEmE2v72WDZo9kz7WwhuslDOili25Ls/edit">notes</a>
| <a href="https://www.youtube.com/playlist?list=PL2h5ikWC8viJY4SNeOpCKTyERToTbJJJA">recordings</a> ]</li>
<li>Metal³ <a href="https://metal3.io/">website</a></li>
</ul>
<h2><a class="header" href="#code-of-conduct" id="code-of-conduct">Code of Conduct</a></h2>
<p>See the <a href="https://github.com/metal3-io/metal3-docs/blob/master/CODE_OF_CONDUCT.md">Contributor Covenant Code of Conduct</a></p>
<h1><a class="header" href="#project-overview" id="project-overview">Project Overview</a></h1>
<h1><a class="header" href="#metal³-components" id="metal³-components">Metal³ Components</a></h1>
<h2><a class="header" href="#baremetal-operator" id="baremetal-operator">Baremetal Operator</a></h2>
<p>Unlike any other Cluster API providers, Metal³ comes with an
extra component called <a href="https://github.com/metal3-io/baremetal-operator">Baremetal Operator</a>
(BMO), which manages the actual bare metal hosts. The reason for
introducing an extra component is because all the other cloud
providers already had built APIs to manage their respective
infrastructure whereas in Metal³ there was no baremetal
infrastructure APIs.</p>
<h3><a class="header" href="#ironic-integration" id="ironic-integration">Ironic integration</a></h3>
<p>Under the hood Baremetal Operator is using OpenStack
<a href="https://docs.openstack.org/ironic/latest/">Ironic</a> as
a provisioning tool to manage the bare metal hosts. Baremetal
Operator doesn’t require you to deploy and manage the Ironic
since it is the job of Metal³ to manage it.</p>
<p>Please note that, although Baremetal Operator utilizes Ironic
from the OpenStack community, it doesn’t bring any other OpenStack
services into your cluster apart from the bare minimum
<a href="https://github.com/metal3-io/metal3-docs/blob/master/design/use-ironic.md">Ironic setup</a>.</p>
<h2><a class="header" href="#cluster-api-provider-metal³" id="cluster-api-provider-metal³">Cluster-api-provider-metal³</a></h2>
<p><a href="https://github.com/metal3-io/cluster-api-provider-metal3">Cluster-api-provider-metal³</a>
(CAPM3) is a provider implementation of the Cluster API. CAPM3
provides Kubernetes APIs to create, configure and manage clusters
on bare metal based environments.</p>
<h1><a class="header" href="#cluster-api-provider-metal³-1" id="cluster-api-provider-metal³-1">Cluster-Api-Provider-Metal³</a></h1>
<h1><a class="header" href="#workflow" id="workflow">Workflow</a></h1>
<h1><a class="header" href="#api-concepts" id="api-concepts">API concepts</a></h1>
<h1><a class="header" href="#baremetal-operator-1" id="baremetal-operator-1">Baremetal Operator</a></h1>
<h1><a class="header" href="#ironic-integration-1" id="ironic-integration-1">Ironic Integration</a></h1>
<h1><a class="header" href="#baremetalhost-provisioning-states" id="baremetalhost-provisioning-states">BaremetalHost Provisioning States</a></h1>
<p>The following diagram shows the possible Provisioning State transitions for the
BaremetalHost object:</p>
<p><a href="overview/bmo/../../images/bmh_states.svg"><img src="overview/bmo/../../images/bmh_states.svg" alt="BaremetalHost ProvisioningState transitions" /></a></p>
<h2><a class="header" href="#created" id="created">Created</a></h2>
<p>Newly created hosts move immediately to Discovered or Registering. No
host stays in the Created state while the operator is working
properly.</p>
<h2><a class="header" href="#unmanaged" id="unmanaged">Unmanaged</a></h2>
<p>An Unmanaged host is missing both the BMC address and credentials
secret name, and does not have any information to access the BMC
for registration.</p>
<h2><a class="header" href="#externally-provisioned" id="externally-provisioned">Externally Provisioned</a></h2>
<p>An Externally Provisioned host was deployed using another tool and
then a host object was created with the externallyProvisioned flag
set. Hosts in this state are monitored, and only their power status is
managed.</p>
<h2><a class="header" href="#registering" id="registering">Registering</a></h2>
<p>The host will stay in the Registering state while the BMC access
details are being validated.</p>
<h2><a class="header" href="#inspecting" id="inspecting">Inspecting</a></h2>
<p>After the host is registered, an agent image will be booted on it
using a ramdisk. The agent collects information about the available
hardware components, and this process is called “inspection.” The host
will stay in the Inspecting state until this process is completed.</p>
<h2><a class="header" href="#match-profile" id="match-profile">Match Profile</a></h2>
<p>A host in the Match Profile state is being matched against a hardware
profile.</p>
<h2><a class="header" href="#ready" id="ready">Ready</a></h2>
<p>A host in the Ready state is available to be provisioned.</p>
<h2><a class="header" href="#provisioning" id="provisioning">Provisioning</a></h2>
<p>While an image is being copied to the host and it is being configured
to run the image the host will be in the Provisioning state.</p>
<h2><a class="header" href="#provisioned" id="provisioned">Provisioned</a></h2>
<p>After an image is copied to the host and the host is running the
image, it will be in the Provisioned state.</p>
<h2><a class="header" href="#deprovisioning" id="deprovisioning">Deprovisioning</a></h2>
<p>When the previously provisioned image is being removed from the host,
it will be in the Deprovisioning state.</p>
<h2><a class="header" href="#error" id="error">Error</a></h2>
<p>If an error occurs during one of the processing states (Registering,
Inspecting, Provisioning, Deprovisioning) the host will enter the
Error state.</p>
<h2><a class="header" href="#deleting" id="deleting">Deleting</a></h2>
<p>When the host is marked to be deleted, it will move from its current
state to Deleting, at which point the resource record is deleted from
kubernetes.</p>
<h1><a class="header" href="#workflow-1" id="workflow-1">Workflow</a></h1>
<h1><a class="header" href="#api-and-field-definitions" id="api-and-field-definitions">API and Field Definitions</a></h1>
<h2><a class="header" href="#baremetalhost" id="baremetalhost">BareMetalHost</a></h2>
<p><strong>Metal³</strong> introduces the concept of <strong>BareMetalHost</strong> resource, which
defines a physical host and its properties. The <strong>BareMetalHost</strong> embeds
two well differentiated sections, the bare metal host specification
and its current status.</p>
<h1><a class="header" href="#metal³-dev-env" id="metal³-dev-env">Metal³-Dev-Env</a></h1>
<h1><a class="header" href="#ip-address-manager" id="ip-address-manager">Ip-Address-Manager</a></h1>
<h1><a class="header" href="#workflow-2" id="workflow-2">Workflow</a></h1>
<h1><a class="header" href="#api-concepts-1" id="api-concepts-1">API concepts</a></h1>
<h1><a class="header" href="#developer-guide" id="developer-guide">Developer Guide</a></h1>
<h1><a class="header" href="#testing" id="testing">Testing</a></h1>
<h1><a class="header" href="#metal³-dev-env-1" id="metal³-dev-env-1">Metal³-Dev-Env</a></h1>
<p>In this sectons we will cover the basics of how to run and use
<a href="https://github.com/metal3-io/metal3-dev-env">Metal³-dev-env</a>
to create a Kubernetes cluster in Metal³ development environment.
Metal³-dev-env is an emulated environment which spins up a set
of Virtual Machines (VM)s and does the management of those VMs
as if they were bare metal hosts.</p>
<h2><a class="header" href="#installation" id="installation">Installation</a></h2>
<h3><a class="header" href="#prerequisites" id="prerequisites">Prerequisites</a></h3>
<ul>
<li>System with CentOS 8 or Ubuntu 20.04 (Focal Fossa)</li>
<li>System with at least 4C CPUs, 16 GB RAM memory.</li>
<li>Run as a user with passwordless sudo access</li>
<li>Export a couple of environment variables if you don’t want to 
use the <a href="https://github.com/metal3-io/metal3-dev-env/blob/master/vars.md">default ones</a></li>
</ul>
<pre><code class="language-shell">export IMAGE_OS=Ubuntu
export CONTAINER_RUNTIME=docker
export EPHEMERAL_CLUSTER=kind
</code></pre>
<p>Either <a href="https://kind.sigs.k8s.io/">kind</a> or <a href="https://minikube.sigs.k8s.io/docs/start/">minikube</a>
can be used for creating a bootstrap
Kubernetes cluster. By default for Ubuntu based systems,
Metal³-dev-env will use kind to create a bootstrap cluster
while for CentOS based systems it is a Minikube cluster. To
manipulate cluster creation tool use  <code>EPHEMERAL_CLUSTER</code> variable:</p>
<pre><code class="language-shell">export  EPHEMERAL_CLUSTER=&lt;...&gt;
</code></pre>
<p>To define what OS distro should be used for the target
cluster nodes please export the <code>IMAGE_OS</code> environment
variable with desired value. Possible options are Ubuntu
and Centos.</p>
<pre><code class="language-shell">export  IMAGE_OS=&lt;...&gt;
</code></pre>
<h3><a class="header" href="#setup" id="setup">Setup</a></h3>
<p>Now that we have exported necessary environment variables,
we can run make which will execute a series of scripts.
You can find more information <a href="https://metal3.io/try-it.html#12-metal3-dev-env-setup">here</a>
about what each script is responsible for.</p>
<pre><code class="language-shell">git clone https://github.com/metal3-io/metal3-dev-env.git
cd /metal3-dev-env
make
</code></pre>
<p>This setup will take approx. 30min, and during that time the scripts will:</p>
<ul>
<li>install necessary packages and tools</li>
<li>make networking configurations</li>
<li>create libvirt VMs</li>
<li>create a bootstrap cluster (kind or minikube)</li>
<li>start necessary containers (ironic, ironic-inspector, vbmc, sushy, dnsmasq, etc.)</li>
<li>deploy Cluster API and Metal³ provider components, like CAPM3 and BMO</li>
<li>apply <code>BareMetalHost</code> Custom Resources (CR)s</li>
</ul>
<p>By the end of the successful run, you should be able to see
<code>BareMetalHost</code> objects in metal3 namespace in Ready state.</p>
<h3><a class="header" href="#provision-cluster-and-machines" id="provision-cluster-and-machines">Provision cluster and machines</a></h3>
<p>Now that we have <code>BareMetalHost</code> objects in <code>Ready</code> state, 
we can start provisioning them. </p>
<h1><a class="header" href="#tilt" id="tilt">Tilt</a></h1>
<h1><a class="header" href="#custom-resources" id="custom-resources">Custom Resources</a></h1>
<h1><a class="header" href="#metal3cluster" id="metal3cluster">Metal3Cluster</a></h1>
<p>The metal3Cluster object contains information related to the deployment of the cluster on baremetal. 
It currently has two specification fields:</p>
<h2><a class="header" href="#metal3cluster-example" id="metal3cluster-example">Metal3Cluster example</a></h2>
<pre><code class="language-yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
kind: Metal3Cluster
metadata:
  name: example_cluster
spec:
  controlPlaneEndpoint:
    host: 192.168.111.249
    port: 6443
noCloudProvider: true
</code></pre>
<h2><a class="header" href="#metal3cluster-spec" id="metal3cluster-spec">Metal3Cluster spec</a></h2>
<p><code>controlPlaneEndpoint</code> - is an endpoint used to communicate
with the target’s cluster apiserver.</p>
<p><code>noCloudProvider</code> - is a boolean. As there is no cloud provider
behind Metal³, this field is usually set to true, meaning that no
external cloud provider will be used to deploy the cluster on.</p>
<h1><a class="header" href="#metal3machine" id="metal3machine">Metal3Machine</a></h1>
<p>The Metal3Machine contains information related to the deployment of the
BareMetalHost such as the image and the host selector. For each machine, there
must be a Metal3Machine associated to it.</p>
<h2><a class="header" href="#metal3machine-example" id="metal3machine-example">Metal3Machine Example</a></h2>
<pre><code class="language-yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
kind: Metal3Machine
metadata:
  name: controlplane-0
spec:
  image:
    url: https://cloud-images.ubuntu.com/bionic/current/bionic-server-cloudimg-amd64.img
    checksum: https://cloud-images.ubuntu.com/bionic/current/bionic-server-cloudimg-amd64.img.md5sum
  hostSelector:
    matchLabels:
      key1: value1
    matchExpressions:
      key: key2
      operator: in
      values: {‘abc’, ‘123’, ‘value2’}
  dataTemplate:
    Name: controlplane-metadata
  metaData:
    Name: controlplane-0-metadata-0
</code></pre>
<h2><a class="header" href="#metal3machine-spec" id="metal3machine-spec">Metal3Machine spec</a></h2>
<h4><a class="header" href="#image" id="image">image</a></h4>
<p>This includes two sub-fields, <code>url</code> and <code>checksum</code>, which
include the URL to the image and the URL to a checksum for that image. These
fields are required. The image will be used for provisioning of the
<code>BareMetalHost</code> chosen by the <code>Machine</code> actuator.</p>
<h4><a class="header" href="#userdata" id="userdata">userData</a></h4>
<p>This includes two sub-fields, <code>name</code> and <code>namespace</code>, which
reference a <code>Secret</code> that contains base64 encoded user-data to be written to
a config drive on the provisioned <code>BareMetalHost</code>. This field is optional and
is automatically set by CAPM3 with the userData from the machine object. If
you want to overwrite the userData, this should be done in the CAPI machine.</p>
<h4><a class="header" href="#datatemplate" id="datatemplate">dataTemplate</a></h4>
<p>This includes a reference to a Metal3DataTemplate object
containing the metadata and network data templates, and includes two fields,
<code>name</code> and <code>namespace</code>.</p>
<h4><a class="header" href="#metadata" id="metadata">metaData</a></h4>
<p>A reference to a secret containing the metadata rendered from
the Metal3DataTemplate metadata template object automatically. In case this
would not be managed by the Metal3DataTemplate controller, if provided by the
user for example, the ownerreference should be set properly to ensure that the
secret belongs to the cluster ownerReference tree (see
<a href="https://cluster-api.sigs.k8s.io/clusterctl/provider-contract.html#ownerreferences-chain">doc</a>).</p>
<h4><a class="header" href="#networkdata" id="networkdata">networkData</a></h4>
<p>A reference to a secret containing the network data
rendered from the Metal3DataTemplate metadata template object automatically.
In case this would not be managed by the Metal3DataTemplate controller, if
provided by the user for example, the ownerreference should be set properly to
ensure that the secret belongs to the cluster ownerReference tree (see
<a href="https://cluster-api.sigs.k8s.io/clusterctl/provider-contract.html#ownerreferences-chain">doc</a>).
The content of the secret should be a yaml equivalent of a json object that
follows the format definition that can be found
<a href="https://docs.openstack.org/nova/latest/_downloads/9119ca7ac90aa2990e762c08baea3a36/network_data.json">here</a>.</p>
<h4><a class="header" href="#hostselector" id="hostselector">hostSelector</a></h4>
<p>Specifies criteria for matching labels on <code>BareMetalHost</code>
objects. This can be used to limit the set of available <code>BareMetalHost</code>
objects chosen for this <code>Machine</code>.</p>
<p>The <code>metaData</code> and <code>networkData</code> field in the <code>spec</code> section are for the user
to give directly a secret to use as metaData or networkData. The <code>userData</code>,
<code>metaData</code> and <code>networkData</code> fields in the <code>status</code> section are for the
controller to store the reference to the secret that is actually being used,
whether it is from one of the spec fields, or somehow generated. This is aimed
at making a clear difference between the desired state from the user (whether
it is with a DataTemplate reference, or direct <code>metaData</code> or <code>userData</code> secrets)
and what the controller is actually using.</p>
<p>The <code>dataTemplate</code> field consists of an object reference to a
Metal3DataTemplate object containing the templates for the metadata and
network data generation for this Metal3Machine. The <code>renderedData</code> field is a
reference to the Metal3Data object created for this machine. If the
dataTemplate field is set but either the <code>renderedData</code>, <code>metaData</code> or
<code>networkData</code> fields in the status are unset, then the Metal3Machine
controller will wait until it can find the Metal3Data object and the rendered
secrets. It will then populate those fields.</p>
<p>When CAPM3 controller will set the different fields in the BareMetalHost,
it will reference the metadata secret and the network data secret
in the BareMetalHost. If any of the <code>metaData</code> or <code>networkData</code> status fields
are unset, that field will also remain unset on the BareMetalHost.</p>
<p>When the Metal3Machine gets deleted, the CAPM3 controller will remove its
ownerreference from the data template object. This will trigger the deletion of
the generated Metal3Data object and the secrets generated for this machine.</p>
<h1><a class="header" href="#baremetalhost-1" id="baremetalhost-1">BareMetalHost</a></h1>
<p><code>BareMetalHost</code> is another CRD which represents a physical host and holds information about hardware inventory.</p>
<h2><a class="header" href="#baremetalhost-example" id="baremetalhost-example">BareMetalHost Example</a></h2>
<p>The following is a complete example from a running cluster of a <em>BareMetalHost</em>
resource (in YAML), it includes its specification and status sections:</p>
<pre><code class="language-yaml">apiVersion: metal3.io/v1alpha1
kind: BareMetalHost
metadata:
  creationTimestamp: &quot;2019-09-20T06:33:35Z&quot;
  finalizers:
  - baremetalhost.metal3.io
  generation: 2
  name: bmo-master-0
  namespace: bmo-project
  resourceVersion: &quot;22642&quot;
  selfLink: /apis/metal3.io/v1alpha1/namespaces/bmo-project/baremetalhosts/bmo-master-0
  uid: 92b2f77a-db70-11e9-9db1-525400764849
spec:
  bmc:
    address: ipmi://10.10.57.19
    credentialsName: bmo-master-0-bmc-secret
  bootMACAddress: 98:03:9b:61:80:48
  consumerRef:
    apiVersion: machine.openshift.io/v1beta1
    kind: Machine
    name: bmo-master-0
    namespace: bmo-project
  externallyProvisioned: true
  hardwareProfile: default
  image:
    checksum: http://172.16.1.100/images/myOSv1/myOS.qcow2.md5sum
    url: http://172.16.1.100/images/myOSv1/myOS.qcow2
  online: true
  userData:
    name: bmo-master-user-data
    namespace: bmo-project
  networkData:
    name: bmo-master-network-data
    namespace: bmo-project
  metaData:
    name: bmo-master-meta-data
    namespace: bmo-project
status:
  errorMessage: &quot;&quot;
  goodCredentials:
    credentials:
      name: bmo-master-0-bmc-secret
      namespace: bmo-project
    credentialsVersion: &quot;5562&quot;
  hardware:
    cpu:
      arch: x86_64
      clockMegahertz: 2000
      count: 40
      flags: []
      model: Intel(R) Xeon(R) Gold 6138 CPU @ 2.00GHz
    firmware:
      bios:
        date: 12/17/2018
        vendor: Dell Inc.
        version: 1.6.13
    hostname: bmo-master-0.localdomain
    nics:
    - ip: 172.22.135.105
      mac: &quot;00:00:00:00:00:00&quot;
      model: unknown
      name: eno1
      pxe: true
      speedGbps: 25
      vlanId: 0
    ramMebibytes: 0
    storage: []
    systemVendor:
      manufacturer: Dell Inc.
      productName: PowerEdge r460
      serialNumber: &quot;&quot;
  hardwareProfile: &quot;&quot;
  lastUpdated: &quot;2019-09-20T07:03:23Z&quot;
  operationalStatus: OK
  poweredOn: true
  provisioning:
    ID: a4438010-3fc6-4c5c-b570-900bbe85da57
    image:
      checksum: &quot;&quot;
      url: &quot;&quot;
    state: externally provisioned
  triedCredentials:
    credentials:
      name: bmo-master-0-bmc-secret
      namespace: bmo-project
    credentialsVersion: &quot;5562&quot;
</code></pre>
<h2><a class="header" href="#baremetalhost-spec" id="baremetalhost-spec">BareMetalHost spec</a></h2>
<p>The <em>BareMetalHost’s</em> <em>spec</em> defines the desired state of the host. It contains
mainly, but not only, provisioning details.</p>
<h4><a class="header" href="#bmc" id="bmc">bmc</a></h4>
<p>The <code>bmc</code> fields contain the connection information for the BMC
(Baseboard Management Controller) on the host.</p>
<p>The sub-fields are</p>
<ul>
<li><em>address</em> -- The URL for communicating with the BMC controller, based
on the provider being used. See below for more details.</li>
<li><em>credentialsName</em> -- A reference to a <em>secret</em> containing the
username and password for the BMC.</li>
<li><em>disableCertificateVerification</em> -- A boolean to skip certificate
validation when true.</li>
</ul>
<p>BMC URLs vary based on the type of BMC and the protocol used to
communicate with them.</p>
<ul>
<li>IPMI
<ul>
<li><code>ipmi://&lt;host&gt;:&lt;port&gt;</code>, an unadorned <code>&lt;host&gt;:&lt;port&gt;</code> is also accepted
and the port is optional, if using the default one (623).</li>
</ul>
</li>
<li>Dell iDRAC
<ul>
<li><code>idrac://</code> (or <code>idrac+http://</code> to disable TLS).</li>
<li><code>idrac-virtualmedia://</code> to use virtual media instead of PXE
for attaching the provisioning image to the host.</li>
</ul>
</li>
<li>Fujitsu iRMC
<ul>
<li><code>irmc://&lt;host&gt;:&lt;port&gt;</code>, where <code>&lt;port&gt;</code> is optional if using the default.</li>
</ul>
</li>
<li>HUAWEI ibmc
<ul>
<li><code>ibmc://&lt;host&gt;:&lt;port&gt;</code> (or <code>ibmc+http://&lt;host&gt;:&lt;port&gt;</code> to disable TLS)</li>
</ul>
</li>
<li>iLO 5 Redfish
<ul>
<li><code>ilo5-redfish://</code> (or <code>ilo5-redfish+http://</code> to disable TLS), the hostname
or IP address, and the path to the system ID are required,
for example <code>ilo5-redfish://myhost.example/redfish/v1/Systems/MySystemExample</code></li>
</ul>
</li>
<li>Redfish
<ul>
<li><code>redfish://</code> (or <code>redfish+http://</code> to disable TLS)</li>
<li><code>redfish-virtualmedia://</code> to use virtual media instead of PXE
for attaching the provisioning image to the host.</li>
<li>The hostname or IP address, and the path to the system ID are
required for all variants.  For example
<code>redfish://myhost.example/redfish/v1/Systems/System.Embedded.1</code>
or <code>redfish://myhost.example/redfish/v1/Systems/1</code></li>
</ul>
</li>
</ul>
<h4><a class="header" href="#online" id="online">online</a></h4>
<p>A boolean indicating whether the host should be powered on (true) or
off (false). Changing this value will trigger a change in power state
on the physical host.</p>
<h4><a class="header" href="#consumerref" id="consumerref">consumerRef</a></h4>
<p>A reference to another resource that is using the host, it could be
empty if the host is not being currently used.  For example, a
<em>Machine</em> resource when the host is being used by the
<a href="https://github.com/kubernetes-sigs/cluster-api"><em>machine-api</em></a>.</p>
<h4><a class="header" href="#externallyprovisioned" id="externallyprovisioned">externallyProvisioned</a></h4>
<p>A boolean indicating whether the host provisioning and deprovisioning
are managed externally. When set, the host’s power status and hardware
inventory will be monitored but no provisioning or deprovisioning
operations are performed on the host.</p>
<h4><a class="header" href="#image-1" id="image-1">image</a></h4>
<p>Holds details for the image to be deployed on a given host.</p>
<p>The sub-fields are</p>
<ul>
<li><em>url</em> -- The URL of an image to deploy to the host.</li>
<li><em>checksum</em> -- The actual checksum or a URL to a file containing
the checksum for the image at <em>image.url</em>.</li>
<li><em>checksumType</em> -- Checksum algorithms can be specified. Currently
only <code>md5</code>, <code>sha256</code>, <code>sha512</code> are recognized. If nothing is specified
<code>md5</code> is assumed.</li>
<li><em>format</em> -- This is the disk format of the image. It can be one of <code>raw</code>,
<code>qcow2</code>, <code>vdi</code>, <code>vmdk</code>, or be left unset. Setting it to raw enables raw
image streaming in Ironic agent for that image.</li>
</ul>
<h4><a class="header" href="#userdata-1" id="userdata-1">userData</a></h4>
<p>A reference to the Secret containing the cloudinit user data and its
namespace, so it can be attached to the host before it boots for
configuring different aspects of the OS (like networking, storage,
...).</p>
<h4><a class="header" href="#networkdata-1" id="networkdata-1">networkData</a></h4>
<p>A reference to the Secret containing the network configuration data
(e.g. network_data.json) and its namespace, so it can be attached to
the host before it boots to set network up</p>
<h4><a class="header" href="#description" id="description">description</a></h4>
<p>A human-provided string to help identify the host.</p>
<h4><a class="header" href="#hardwareprofile" id="hardwareprofile">hardwareProfile</a></h4>
<p><strong>This field is deprecated. See rootDeviceHints instead.</strong></p>
<p>The name of the hardware profile to use. The following are the current
supported <code>hardwareProfile</code> settings and their corresponding root
devices.</p>
<table><thead><tr><th><strong>hardwareProfile</strong></th><th><strong>Root Device</strong></th></tr></thead><tbody>
<tr><td><code>unknown</code></td><td>/dev/sda</td></tr>
<tr><td><code>libvirt</code></td><td>/dev/vda</td></tr>
<tr><td><code>dell</code></td><td>HCTL: 0:0:0:0</td></tr>
<tr><td><code>dell-raid</code></td><td>HCTL: 0:2:0:0</td></tr>
<tr><td><code>openstack</code></td><td>/dev/vdb</td></tr>
</tbody></table>
<p><strong>NOTE:</strong> These are subject to change.</p>
<h4><a class="header" href="#rootdevicehints" id="rootdevicehints">rootDeviceHints</a></h4>
<p>Guidance for how to choose the device to receive the image being
provisioned. The storage devices are examined in the order they are
discovered during inspection and the hint values are compared to the
inspected values. The first discovered device that matches is
used. Hints can be combined, and if multiple hints are provided then a
device must match all hints in order to be selected.</p>
<p>The sub-fields are</p>
<ul>
<li><em>deviceName</em> -- A string containing a Linux device name like
<code>/dev/vda</code>. The hint must match the actual value exactly.</li>
<li><em>hctl</em> -- A string containing a SCSI bus address like
<code>0:0:0:0</code>. The hint must match the actual value exactly.</li>
<li><em>model</em> -- A string containing a vendor-specific device
identifier. The hint can be a substring of the actual value.</li>
<li><em>vendor</em> -- A string containing the name of the vendor or
manufacturer of the device. The hint can be a substring of the
actual value.</li>
<li><em>serialNumber</em> -- A string contianing the device serial
number. The hint must match the actual value exactly.</li>
<li><em>minSizeGigabytes</em> -- An integer representing the minimum size of the
device in Gigabytes.</li>
<li><em>wwn</em> -- A string containing the unique storage identifier. The
hint must match the actual value exactly.</li>
<li><em>wwnWithExtension</em> -- A string containing the unique storage
identifier with the vendor extension appended. The hint must match
the actual value exactly.</li>
<li><em>wwnVendorExtension</em> -- A string containing the unique vendor
storage indentifier. The hint must match the actual value exactly.</li>
<li><em>rotational</em> -- A boolean indicating whether the device should be
a rotating disk (<code>true</code>) or not (<code>false</code>).</li>
</ul>
<h2><a class="header" href="#baremetalhost-status" id="baremetalhost-status">BareMetalHost status</a></h2>
<p>Moving onto the next block, the <em>BareMetalHost’s</em> <em>status</em> which represents
the host’s current state. Including tested credentials, current hardware
details, etc.</p>
<h4><a class="header" href="#goodcredentials" id="goodcredentials">goodCredentials</a></h4>
<p>A reference to the secret and its namespace holding the last set of
BMC credentials the system was able to validate as working.</p>
<h4><a class="header" href="#triedcredentials" id="triedcredentials">triedCredentials</a></h4>
<p>A reference to the secret and its namespace holding the last set of
BMC credentials that were sent to the provisioning backend.</p>
<h4><a class="header" href="#lastupdated" id="lastupdated">lastUpdated</a></h4>
<p>The timestamp of the last time the status of the host was updated.</p>
<h4><a class="header" href="#operationalstatus" id="operationalstatus">operationalStatus</a></h4>
<p>The status of the server. Value is one of the following:</p>
<ul>
<li><em>OK</em> -- Indicates all the details for the host are known and working,
meaning the host is correctly configured and manageable.</li>
<li><em>discovered</em> -- Implies some of the host’s details are either
not working correctly or missing. For example, the BMC address is known
but the login credentials are not.</li>
<li><em>error</em> -- Indicates the system found some sort of irrecuperable error.
Refer to the <em>errorMessage</em> field in the status section for more details.</li>
</ul>
<h4><a class="header" href="#errormessage" id="errormessage">errorMessage</a></h4>
<p>Details of the last error reported by the provisioning backend, if
any.</p>
<h4><a class="header" href="#hardware" id="hardware">hardware</a></h4>
<p>The details for hardware capabilities discovered on the host. These
are filled in by the provisioning agent when the host is registered.</p>
<p>The sub-fields are</p>
<ul>
<li><em><code>nics</code></em> -- List of network interfaces for the host.
<ul>
<li><em>name</em> -- A string identifying the network device,
e.g. <em>nic-1</em>.</li>
<li><em>mac</em> -- The MAC address of the NIC.</li>
<li><em>ip</em> -- The IP address of the NIC, if one was assigned
when the discovery agent ran.</li>
<li><em>speedGbps</em> -- The speed of the device in Gbps.</li>
<li><em>vlans</em> -- A list holding all the VLANs available for this NIC.</li>
<li><em>vlanId</em> -- The untagged VLAN ID.</li>
<li><em>pxe</em> -- Whether the NIC is able to boot using PXE.</li>
</ul>
</li>
<li><em><code>storage</code></em> -- List of storage (disk, SSD, etc.) available to the host.
<ul>
<li><em>name</em> -- A string identifying the storage device,
e.g. <em>disk 1 (boot)</em>.</li>
<li><em>rotational</em> -- Either true or false, indicates whether the disk
is rotational.</li>
<li><em>sizeBytes</em> -- Size of the storage device.</li>
<li><em>serialNumber</em> -- The device’s serial number.</li>
</ul>
</li>
<li><em><code>cpu</code></em> -- Details of the CPU(s) in the system.
<ul>
<li><em>arch</em> -- The architecture of the CPU.</li>
<li><em>model</em> -- The model string.</li>
<li><em>clockMegahertz</em> -- The speed in GHz of the CPU.</li>
<li><em>flags</em> -- List of CPU flags, e.g. ‘mmx’,’sse’,’sse2’,’vmx’, ...</li>
<li><em>count</em> -- Amount of these CPUs available in the system.</li>
</ul>
</li>
<li><em><code>firmware</code></em> -- Contains BIOS information like for instance its <em>vendor</em>
and <em>version</em>.</li>
<li><em><code>systemVendor</code></em> -- Contains information about the host’s <em>manufacturer</em>,
the <em>productName</em> and <em>serialNumber</em>.</li>
<li><em><code>ramMebibytes</code></em> -- The host’s amount of memory in Mebibytes.</li>
</ul>
<h4><a class="header" href="#hardwareprofile-status" id="hardwareprofile-status">hardwareProfile (status)</a></h4>
<p><strong>This field is deprecated. See rootDeviceHints instead.</strong></p>
<p>The name of the hardware profile that matches the hardware discovered
on the host based on the details saved to the <em>Hardware</em> section. If
the hardware does not match any known profile, the value <code>unknown</code>
will be set on this field and is used by default. In practice, this
only affects which device the OS image will be written to. The
following are the current supported <code>hardwareProfile</code> settings and
their corresponding root devices.</p>
<table><thead><tr><th><strong>hardwareProfile</strong></th><th><strong>Root Device</strong></th></tr></thead><tbody>
<tr><td><code>unknown</code></td><td>/dev/sda</td></tr>
<tr><td><code>libvirt</code></td><td>/dev/vda</td></tr>
<tr><td><code>dell</code></td><td>HCTL: 0:0:0:0</td></tr>
<tr><td><code>dell-raid</code></td><td>HCTL: 0:2:0:0</td></tr>
<tr><td><code>openstack</code></td><td>/dev/vdb</td></tr>
</tbody></table>
<p><strong>NOTE:</strong> These are subject to change.</p>
<h4><a class="header" href="#poweredon" id="poweredon">poweredOn</a></h4>
<p>Boolean indicating whether the host is powered on.</p>
<p>See <em>online</em> on the <em>BareMetalHost’s</em> <em>Spec</em>.</p>
<h4><a class="header" href="#provisioning-1" id="provisioning-1">provisioning</a></h4>
<p>Settings related to deploying an image to the host.</p>
<ul>
<li><em>state</em> -- The current state of any ongoing provisioning operation.
The following are the currently supported ones:
<ul>
<li><em>&lt;empty string&gt;</em> -- There is no provisioning happening, at the moment.</li>
<li><em>registration error</em> -- The details for the host’s BMC are
either incorrect or incomplete therfore the host could not be managed.</li>
<li><em>registering</em> -- The host’s BMC details are being checked.</li>
<li><em>match profile</em> -- The discovered hardware details on the host
are being compared against known profiles.</li>
<li><em>ready</em> -- The host is available to be consumed.</li>
<li><em>provisioning</em> -- An image is being written to the host’s disk(s).</li>
<li><em>provisioning error</em> -- The image could not be written to the host.</li>
<li><em>provisioned</em> -- An image has been completely written to the host’s
disk(s).</li>
<li><em>externally provisioned</em> -- Metal³ does not manage the image on the host.</li>
<li><em>deprovisioning</em> -- The image is being wiped from the host’s disk(s).</li>
<li><em>inspecting</em> -- The hardware details for the host are being collected
by an agent.</li>
<li><em>power management error</em> -- An error was found while trying to power
the host either on or off.</li>
</ul>
</li>
<li><em>id</em> -- The unique identifier for the service in the underlying
provisioning tool.</li>
<li><em>image</em> -- The image most recently provisioned to the host.</li>
<li><em>rootDeviceHints</em> -- The root device selection instructions used
for the most recent provisioning operation.</li>
</ul>
<h1><a class="header" href="#metal3machinetemplate" id="metal3machinetemplate">Metal3MachineTemplate</a></h1>
<p>The metal3MachineTemplate contains the template to create Metal3Machine</p>
<h2><a class="header" href="#metal3machinetemplate-example" id="metal3machinetemplate-example">Metal3MachineTemplate example</a></h2>
<pre><code class="language-yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
kind: Metal3MachineTemplate
metadata:
  name: md-0
spec:
  template:
    spec:
      image:
        url: https://cloud-images.ubuntu.com/bionic/current/bionic-server-cloudimg-amd64.img
        checksum: https://cloud-images.ubuntu.com/bionic/current/bionic-server-cloudimg-amd64.img.md5sum
      hostSelector:
        matchLabels:
          key1: value1
        matchExpressions:
          key: key2
          operator: in
          values: {‘abc’, ‘123’, ‘value2’}
      dataTemplate:
        Name: md-0-metadata
</code></pre>
<h2><a class="header" href="#metal3machinetemplate-spec" id="metal3machinetemplate-spec">Metal3MachineTemplate spec</a></h2>
<h2><a class="header" href="#metal3machinetemplate-status" id="metal3machinetemplate-status">Metal3MachineTemplate status</a></h2>
<h1><a class="header" href="#ippool" id="ippool">IpPool</a></h1>
<h2><a class="header" href="#ippool-example" id="ippool-example">IpPool example</a></h2>
<pre><code class="language-yaml">apiVersion: ipam.metal3.io/v1alpha1
kind: IPPool
metadata:
  name: pool-1
  namespace: default
  ownerReferences:
  - apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
    kind: Metal3Cluster
    name: cluster-1
spec:
  clusterName: cluster-1
  pools:
    - start: 192.168.0.10
      end: 192.168.0.15
      subnet: 192.168.0.0/24
      gateway: 192.168.0.1
      prefix: 24
      dnsServers:
        - 8.8.8.8
    - start: 192.168.1.10
      end: 192.168.1.15
      subnet: 192.168.1.0/24
      gateway: 192.168.1.1
      prefix: 24
  gateway: 192.168.1.1
  prefix: 24
  dnsServers:
    - 8.8.4.4
  preAllocations:
    &quot;RenderedData-10&quot;: 192.168.0.9
    &quot;RenderedData-9&quot;: 192.168.0.8
  namePrefix: &quot;provisioning&quot;
status:
  lastUpdated: &quot;2020-04-02T06:36:09Z&quot;
  allocations:
    &quot;RenderedData-1&quot;: &quot;192.168.0.11&quot;
    &quot;RenderedData-10&quot;: 192.168.0.9
    &quot;RenderedData-9&quot;: 192.168.0.8
</code></pre>
<h2><a class="header" href="#ippool-spec" id="ippool-spec">IpPool spec</a></h2>
<h4><a class="header" href="#pools" id="pools">pools</a></h4>
<p>A list that contains a list of IP address pools.</p>
<h4><a class="header" href="#poolsstart" id="poolsstart">pools.start</a></h4>
<p>Start IP addresses of the pool. Specifying single ip addresses
can be achieved by setting the start and end ip address to that 
single ip address.</p>
<h4><a class="header" href="#poolsend" id="poolsend">pools.end</a></h4>
<p>End IP addresses of the pool.</p>
<h4><a class="header" href="#poolssubnet" id="poolssubnet">pools.subnet</a></h4>
<p>A field that allows to verify that the allocated IP is in the 
pool and from which the start and end ip addresses can be inferred.</p>
<h4><a class="header" href="#prefix" id="prefix">prefix</a></h4>
<p>A prefix length from a network in Classless Inter-Domain 
Routing (CIDR) notation. It can be given for each pool of
the list, or globally. If given for a pool it will override
the global setting, that is default value. It will be set
on the <code>IPAddress</code> and can be fetched from a Template.</p>
<h4><a class="header" href="#dnsservers" id="dnsservers">dnsServers</a></h4>
<p>An IP address of a dns server. It can be given for each
pool of the list, or globally. If given for a pool it
will override the global setting, that is default value.
It will be set on the <code>IPAddress</code> and can be fetched
from a Template.</p>
<h4><a class="header" href="#gateway" id="gateway">gateway</a></h4>
<p>An IP address of a network gateway. It can be given for
each pool of the list, or globally. If given for a pool
it will override the global setting, that is default value.
It will be set on the <code>IPAddress</code> and can be fetched from
a Template.</p>
<h4><a class="header" href="#preallocations" id="preallocations">preAllocations</a></h4>
<p>A map of object name and ip address that allow a
user to specify a set of static allocations for some objects.</p>
<h4><a class="header" href="#nameprefix" id="nameprefix">namePrefix</a></h4>
<p>It contains the prefix used to name the IPAddress objects created.
It must remain the same for a subnet, across updates or changes in the
<code>IPPool</code> object to keep the existing leases.</p>
<h2><a class="header" href="#ippool-status" id="ippool-status">IpPool status</a></h2>
<h4><a class="header" href="#lastupdated-1" id="lastupdated-1">lastUpdated</a></h4>
<p>A field with the timestamp of the last update.</p>
<blockquote>
<p><strong>Note:</strong> In case of an error during the allocation (pool exhaustion for example),
the error would be reported on the <code>Claim</code> object, in the <code>errorMessage</code> field.
The allocations map will map the IP address to the <code>RenderedData</code> object it was
allocated for and the addresses will map the <code>RenderedData</code> objects with the
<code>IPAddress</code> objects.</p>
</blockquote>
<h1><a class="header" href="#ipclaim" id="ipclaim">IpClaim</a></h1>
<h2><a class="header" href="#ipclaim-example" id="ipclaim-example">IpClaim example</a></h2>
<pre><code class="language-yaml">apiVersion: ipam.metal3.io/v1alpha1
kind: IPClaim
metadata:
  name: RenderedData-1
  namespace: default
  ownerReferences:
  - apiVersion: metadata.metal3.io/v1alpha1
    kind: Data
    name: data-1
spec:
  owner:
    name: RenderedData-1
  pool:
    name: pool-1
status:
  ipAddress:
    name: pool-1-192-168-0-11
  errorMessage: &quot;&quot;
</code></pre>
<h2><a class="header" href="#ipclaim-spec" id="ipclaim-spec">IpClaim spec</a></h2>
<h2><a class="header" href="#ipclaim-status" id="ipclaim-status">IpClaim status</a></h2>
<h1><a class="header" href="#ipaddress" id="ipaddress">IPAddress</a></h1>
<h2><a class="header" href="#ipaddress-example" id="ipaddress-example">IPAddress example</a></h2>
<pre><code class="language-yaml">apiVersion: ipam.metal3.io/v1alpha1
kind: IPAddress
metadata:
  name: pool-1-192-168-0-11
  namespace: default
  ownerReferences:
  - apiVersion: ipam.metal3.io/v1alpha1
    kind: IPPool
    name: pool-1
  - apiVersion: ipam.metal3.io/v1alpha1
    kind: IPClaim
    name: RenderedData-1
spec:
  claim:
    Name: RenderedData-1
  Address: 192.168.0.11
  prefix: 24
  gateway: 192.168.0.1
  dnsServers:
    - 8.8.8.8
  pool:
    Name: pool-1
status:
  ready: true
</code></pre>
<h2><a class="header" href="#ipaddress-spec" id="ipaddress-spec">IPAddress spec</a></h2>
<h2><a class="header" href="#ipaddress-status" id="ipaddress-status">IPAddress status</a></h2>
<h1><a class="header" href="#metal3data" id="metal3data">Metal3Data</a></h1>
<p>The output of the controller would be a Metal3Data object,one per node linking to the
Metal3DataTemplate object and the associated secrets</p>
<h2><a class="header" href="#metal3data-example" id="metal3data-example">Metal3Data example</a></h2>
<pre><code class="language-yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
kind: Metal3Data
metadata:
  name: nodepool-1-0
  namespace: default
  ownerReferences:
  - apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
    controller: true
    kind: Metal3DataTemplate
    name: nodepool-1
spec:
  index: 0
  metaData:
    name: machine-1-metadata
    namespace: default
  networkData:
    name: machine-1-metadata
    namespace: default
  metal3Machine:
    name: machine-1
    namespace: default
status:
  ready: true
  error: false
  errorMessage: &quot;&quot;
</code></pre>
<h2><a class="header" href="#metal3data-spec" id="metal3data-spec">Metal3Data spec</a></h2>
<p>The Metal3Data contains the index of this node, and links to the secrets
generated and to the Metal3Machine using this Metal3Data object.</p>
<p>If the Metal3DataTemplate object is updated, the generated secrets will not be
updated, to allow for reprovisioning of the nodes in the exact same state as
they were initially provisioned. Hence, to do an update, it is necessary to do
a rolling upgrade of all nodes.</p>
<p>The reconciliation of the Metal3DataTemplate object will also be triggered by
changes on Metal3Machines. In the case that a Metal3Machine gets modified, if
the <code>dataTemplate</code> references a Metal3DataTemplate, that <em>Metal3DataClaim</em>
object will be reconciled. There will be two cases:</p>
<ul>
<li>An already generated Metal3Data object exists for that <em>Metal3DataClaim</em>. If
the reference is not in the <em>Metal3DataClaim</em> object, the reconciler will add
it. The reconciler will also verify that the required secrets exist. If they
do not, they will be created.</li>
<li>if no Metal3Data exists for that <em>Metal3DataClaim</em>, then the
reconciler will create one and fill the respective field with the secret name.</li>
</ul>
<p>To create a Metal3Data object, the <em>Metal3DataClaim</em> controller will select an
index for that Metal3Machine. The selection happens by selecting the lowest
available index that is not in use. To do that, the controller will list all
existing Metal3Data object linked to this Metal3DataTemplate and to get the
unavailable indexes. The indexes always start from 0 and increment by 1. The
lowest available index is to be used next. The <code>dataNames</code> field contains the
map of Metal3Machine to Metal3Data and the <code>indexes</code> contains the map of
allocated indexes and claims.</p>
<p>Once the next lowest available index is found, it will create the Metal3Data
object. The name would be a concatenation of the Metal3DataTemplate name and
index. Upon conflict, it will fetch again the list to consider the new list of
Metal3Data and try to create the new object with the new index, this will happen
until the new object is created successfully. Upon success, it will render the
content values, and create the secrets containing the rendered data. The
controller will generate the content based on the <code>metaData</code> or <code>networkData</code>
field of the Metal3DataTemplate Specs. The <em>ready</em> field in <em>renderedData</em> will
then be set accordingly. If any error happens during the rendering, an error
message will be added.</p>
<h1><a class="header" href="#metal3dataclaim" id="metal3dataclaim">Metal3DataClaim</a></h1>
<p>The <code>Metal3DataClaim</code> object will reference its target <code>Metal3DataTemplate</code>
object.</p>
<h2><a class="header" href="#metal3dataclaim-example" id="metal3dataclaim-example">Metal3DataClaim example</a></h2>
<pre><code class="language-yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
kind: Metal3DataClaim
metadata:
  name: machine-1
  namespace: default
  ownerReferences:
  - apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
    controller: true
    kind: Metal3Machine
    name: machine-1
spec:
  template:
    name: nodepool-1
status:
  renderedData:
    name: nodepool-1-0
  errorMessage: &quot;&quot;
</code></pre>
<h2><a class="header" href="#metal3dataclaim-spec" id="metal3dataclaim-spec">Metal3DataClaim spec</a></h2>
<!-- Add spec info -->
<h2><a class="header" href="#metal3dataclaim-status" id="metal3dataclaim-status">Metal3DataClaim status</a></h2>
<h4><a class="header" href="#rendereddata" id="rendereddata">renderedData</a></h4>
<p>A reference to the <code>Metal3Data</code> object. </p>
<h4><a class="header" href="#errormessage-1" id="errormessage-1">errorMessage</a></h4>
<p>A description of the error.</p>
<h1><a class="header" href="#metal3datatemplate" id="metal3datatemplate">Metal3DataTemplate</a></h1>
<h2><a class="header" href="#metal3datatemplate-example" id="metal3datatemplate-example">Metal3DataTemplate example</a></h2>
<pre><code class="language-yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
kind: Metal3DataTemplate
metadata:
  name: nodepool-1
  namespace: default
  ownerReferences:
  - apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
    controller: true
    kind: Metal3Cluster
    name: cluster-1
spec:
  metaData:
    strings:
      - key: abc
        value: def
    objectNames:
      - key: name_m3m
        object: metal3machine
      - key: name_machine
        object: machine
      - key: name_bmh
        object: baremetalhost
    indexes:
      - key: index
        offset: 0
        step: 1
    ipAddressesFromIPPool:
      - key: ip
        Name: pool-1
    prefixesFromIPPool:
      - key: ip
        Name: pool-1
    gatewaysFromIPPool:
      - key: gateway
        Name: pool-1
    dnsServersFromIPPool:
      - key: dns
        Name: pool-1
    fromHostInterfaces:
      - key: mac
        interface: &quot;eth0&quot;
    fromLabels:
      - key: label-1
        object: machine
        label: mylabelkey
    fromAnnotations:
      - key: annotation-1
        object: machine
        annotation: myannotationkey
  networkData:
    links:
      ethernets:
        - type: &quot;phy&quot;
          id: &quot;enp1s0&quot;
          mtu: 1500
          macAddress:
            fromHostInterface: &quot;eth0&quot;
        - type: &quot;phy&quot;
          id: &quot;enp2s0&quot;
          mtu: 1500
          macAddress:
            fromHostInterface: &quot;eth1&quot;
      bonds:
        - id: &quot;bond0&quot;
          mtu: 1500
          macAddress:
            string: &quot;XX:XX:XX:XX:XX:XX&quot;
          bondMode: &quot;802.1ad&quot;
          bondLinks:
            - enp1s0
            - enp2s0
      vlans:
        - id: &quot;vlan1&quot;
          mtu: 1500
          macAddress:
            string: &quot;YY:YY:YY:YY:YY:YY&quot;
          vlanId: 1
          vlanLink: bond0
    networks:
      ipv4DHCP:
        - id: &quot;provisioning&quot;
          link: &quot;bond0&quot;

      ipv4:
        - id: &quot;Baremetal&quot;
          link: &quot;vlan1&quot;
          IPAddressFromIPPool: pool-1
          routes:
            - network: &quot;0.0.0.0&quot;
              netmask: 0
              gateway:
                fromIPPool: pool-1
              services:
                dns:
                  - &quot;8.8.4.4&quot;
                dnsFromIPPool: pool-1
      ipv6DHCP:
        - id: &quot;provisioning6&quot;
          link: &quot;bond0&quot;
      ipv6SLAAC:
        - id: &quot;provisioning6slaac&quot;
          link: &quot;bond0&quot;
      ipv6:
        - id: &quot;Baremetal6&quot;
          link: &quot;vlan1&quot;
          IPAddressFromIPPool: pool6-1
          routes:
            - network: &quot;0::0&quot;
              netmask: 0
              gateway:
                string: &quot;2001:0db8:85a3::8a2e:0370:1&quot;
              services:
                dns:
                  - &quot;2001:4860:4860::8844&quot;
                dnsFromIPPool: pool6-1
    services:
      dns:
        - &quot;8.8.8.8&quot;
        - &quot;2001:4860:4860::8888&quot;
status:
  indexes:
    &quot;0&quot;: &quot;machine-1&quot;
  dataNames:
    &quot;machine-1&quot;: nodepool-1-0
  lastUpdated: &quot;2020-04-02T06:36:09Z&quot;
</code></pre>
<h2><a class="header" href="#metal3datatemplate-specmetadata" id="metal3datatemplate-specmetadata">Metal3DataTemplate spec.metaData</a></h2>
<h4><a class="header" href="#strings" id="strings">strings</a></h4>
<p>Renders the given string as value in the metadata. It takes a
<code>value</code> attribute.</p>
<h4><a class="header" href="#objectnames" id="objectnames">objectNames</a></h4>
<p>Renders the name of the object that matches the type given.
It takes an <code>object</code> attribute, containing the type of the object.</p>
<h4><a class="header" href="#indexes" id="indexes">indexes</a></h4>
<p>Renders the index of the current object, with the offset from the
<code>offset</code> field and using the step from the <code>step</code> field. The following
conditions must be matched : <code>offset</code> &gt;= 0 and <code>step</code> &gt;= 1
if the step is unspecified (default value being 0), the controller will
automatically change it for 1. The <code>prefix</code> and <code>suffix</code> attributes are to
provide a prefix and a suffix for the rendered index.</p>
<h4><a class="header" href="#ipaddressesfromippool" id="ipaddressesfromippool">ipAddressesFromIPPool</a></h4>
<p>Renders an ip address from an <em>IPPool</em>
object. The <em>IPPool</em> objects are defined in the
<a href="https://github.com/metal3-io/ip-address-manager">IP Address manager repo</a></p>
<h4><a class="header" href="#prefixesfromippool" id="prefixesfromippool">prefixesFromIPPool</a></h4>
<p>Renders a network prefix from an <em>IPPool</em>
object. The <em>IPPool</em> objects are defined in the
<a href="https://github.com/metal3-io/ip-address-manager">IP Address manager repo</a></p>
<h4><a class="header" href="#gatewaysfromippool" id="gatewaysfromippool">gatewaysFromIPPool</a></h4>
<p>Renders a network gateway from an <em>IPPool</em>
object. The <em>IPPool</em> objects are defined in the
<a href="https://github.com/metal3-io/ip-address-manager">IP Address manager repo</a></p>
<h4><a class="header" href="#dnsserversfromippool" id="dnsserversfromippool">dnsServersFromIPPool</a></h4>
<p>Renders a dns servers list from an <em>IPPool</em>
object. The <em>IPPool</em> objects are defined in the
<a href="https://github.com/metal3-io/ip-address-manager">IP Address manager repo</a></p>
<h4><a class="header" href="#fromhostinterfaces" id="fromhostinterfaces">fromHostInterfaces</a></h4>
<p>Renders the MAC address of the BareMetalHost that
matches the name given as value.</p>
<h4><a class="header" href="#fromlabels" id="fromlabels">fromLabels</a></h4>
<p>Renders the content of a label on an object or an empty string
if the label is absent. It takes an <code>object</code> attribute to specify the type of
the object where to fetch the label, and a <code>label</code> attribute that contains the
label key.</p>
<h4><a class="header" href="#fromannotations" id="fromannotations">fromAnnotations</a></h4>
<p>Renders the content of a annotation on an object or an
empty string if the annotation is absent. It takes an <code>object</code> attribute to
specify the type of the object where to fetch the annotation, and an
<code>annotation</code> attribute that contains the annotation key.</p>
<p>For each object, the attribute <strong>key</strong> is required.</p>
<h3><a class="header" href="#metal3datatemplate-specnetworkdata" id="metal3datatemplate-specnetworkdata">Metal3DataTemplate spec.networkData</a></h3>
<p>The <code>networkData</code> field will contain three items :</p>
<ul>
<li><strong>links</strong>: a list of layer 2 interface</li>
<li><strong>networks</strong>: a list of layer 3 networks</li>
<li><strong>services</strong> : a list of services (DNS)</li>
</ul>
<h4><a class="header" href="#links-specifications" id="links-specifications">Links specifications</a></h4>
<p>The object for the <strong>links</strong> section list can be:</p>
<ul>
<li><strong>ethernets</strong>: a list of ethernet interfaces</li>
<li><strong>bonds</strong>: a list of bond interfaces</li>
<li><strong>vlans</strong>: a list of vlan interfaces</li>
</ul>
<p>The <strong>links/ethernets</strong> objects contain the following:</p>
<ul>
<li><strong>type</strong>: Type of the ethernet interface</li>
<li><strong>id</strong>: Interface name</li>
<li><strong>mtu</strong>: Interface MTU</li>
<li><strong>macAddress</strong>: an object to render the MAC Address</li>
</ul>
<p>The <strong>links/ethernets/type</strong> can be one of :</p>
<ul>
<li>bridge</li>
<li>dvs</li>
<li>hw_veb</li>
<li>hyperv</li>
<li>ovs</li>
<li>tap</li>
<li>vhostuser</li>
<li>vif</li>
<li>phy</li>
</ul>
<p>The <strong>links/ethernets/macAddress</strong> object can be one of:</p>
<ul>
<li><strong>string</strong>: with the desired Mac given as a string</li>
<li><strong>fromHostInterface</strong>: with the interface name from BareMetalHost
hardware details.</li>
</ul>
<p>The <strong>links/bonds</strong> object contains the following:</p>
<ul>
<li><strong>id</strong>: Interface name</li>
<li><strong>mtu</strong>: Interface MTU</li>
<li><strong>macAddress</strong>: an object to render the MAC Address</li>
<li><strong>bondMode</strong>: The bond mode</li>
<li><strong>bondLinks</strong> : a list of links to use for the bond</li>
</ul>
<p>The <strong>links/bonds/bondMode</strong> can be one of :</p>
<ul>
<li>802.1ad</li>
<li>balance-rr</li>
<li>active-backup</li>
<li>balance-xor</li>
<li>broadcast</li>
<li>balance-tlb</li>
<li>balance-alb</li>
</ul>
<p>The <strong>links/vlans</strong> object contains the following:</p>
<ul>
<li><strong>id</strong>: Interface name</li>
<li><strong>mtu</strong>: Interface MTU</li>
<li><strong>macAddress</strong>: an object to render the MAC Address</li>
<li><strong>vlanId</strong>: The vlan ID</li>
<li><strong>vlanLink</strong> : The link on which to create the vlan</li>
</ul>
<h4><a class="header" href="#the-networks-specifications" id="the-networks-specifications">The networks specifications</a></h4>
<p>The object for the <strong>networks</strong> section can be:</p>
<ul>
<li><strong>ipv4</strong>: a list of ipv4 static allocations</li>
<li><strong>ipv4DHCP</strong>: a list of ipv4 DHCP based allocations</li>
<li><strong>ipv6</strong>: a list of ipv6 static allocations</li>
<li><strong>ipv6DHCP</strong>: a list of ipv6 DHCP based allocations</li>
<li><strong>ipv6SLAAC</strong>: a list of ipv6 SLAAC based allocations</li>
</ul>
<p>The <strong>networks/ipv4</strong> object contains the following:</p>
<ul>
<li><strong>id</strong>: the network name</li>
<li><strong>link</strong>: The name of the link to configure this network for</li>
<li><strong>ipAddressFromIPPool</strong>: renders an ip address from an <em>IPPool</em>
object. The <em>IPPool</em> objects are defined in the
<a href="https://github.com/metal3-io/ip-address-manager">IP Address manager repo</a></li>
<li><strong>routes</strong>: the list of route objects</li>
</ul>
<p>The <em><em>networks/ipv</em>/routes</em>* is a route object containing:</p>
<ul>
<li><strong>network</strong>: the subnet to reach</li>
<li><strong>netmask</strong>: the mask of the subnet as integer</li>
<li><strong>gateway</strong>: the gateway to use, it can either be given as a string in
<em>string</em> or as an IPPool name in <em>fromIPPool</em></li>
<li><strong>services</strong>: a list of services object as defined later</li>
</ul>
<p>The <strong>networks/ipv4Dhcp</strong> object contains the following:</p>
<ul>
<li><strong>id</strong>: the network name</li>
<li><strong>link</strong>: The name of the link to configure this network for</li>
<li><strong>routes</strong>: the list of route objects</li>
</ul>
<p>The <strong>networks/ipv6</strong> object contains the following:</p>
<ul>
<li><strong>id</strong>: the network name</li>
<li><strong>link</strong>: The name of the link to configure this network for</li>
<li><strong>ipAddressFromIPPool</strong>: renders an ip address from an <em>IPPool</em>
object. The <em>IPPool</em> objects are defined in the
<a href="https://github.com/metal3-io/ip-address-manager">IP Address manager repo</a></li>
<li><strong>routes</strong>: the list of route objects</li>
</ul>
<p>The <strong>networks/ipv6Dhcp</strong> object contains the following:</p>
<ul>
<li><strong>id</strong>: the network name</li>
<li><strong>link</strong>: The name of the link to configure this network for</li>
<li><strong>routes</strong>: the list of route objects</li>
</ul>
<p>The <strong>networks/ipv6Slaac</strong> object contains the following:</p>
<ul>
<li><strong>id</strong>: the network name</li>
<li><strong>link</strong>: The name of the link to configure this network for</li>
<li><strong>routes</strong>: the list of route objects</li>
</ul>
<h4><a class="header" href="#the-services-specifications" id="the-services-specifications">the services specifications</a></h4>
<p>The object for the <strong>services</strong> section can be:</p>
<ul>
<li><strong>dns</strong>: a list of dns service with the ip address of a dns server</li>
<li><strong>dnsFromIPPool</strong>: the IPPool from which to fetch the dns servers list</li>
</ul>
<h3><a class="header" href="#the-generated-secrets" id="the-generated-secrets">The generated secrets</a></h3>
<p>The name of the secret will be made of a prefix and the index. The Metal3Machine
object name will be used as the prefix. A <code>-metadata-</code> or <code>-networkdata-</code> will
be added between the prefix and the index.</p>
<h2><a class="header" href="#deployment-flow" id="deployment-flow">Deployment flow</a></h2>
<h3><a class="header" href="#manual-secret-creation" id="manual-secret-creation">Manual secret creation</a></h3>
<p>In the case where the Metal3Machine is created without a <code>dataTemplate</code> value,
if the <code>metaData</code> or <code>networkData</code> fields are set (one or both), the
Metal3Machine reconciler will fetch the secret, set the status field and
directly start the provisioning of the BareMetalHost using the secrets if given.
If one of the secrets does not exist, the controller will wait to start the
provisioning of the BareMetalHost until it exists.</p>
<h3><a class="header" href="#dynamic-secret-creation" id="dynamic-secret-creation">Dynamic secret creation</a></h3>
<p>In the case where the Metal3Machine is created with a <code>dataTemplate</code> value, the
Metal3Machine reconciler will create a <em>Metal3DataClaim</em> for that object.</p>
<p>The <em>Metal3DataClaim</em> would then be reconciled, and its controller will create
an index for this <em>Metal3DataClaim</em> if it does not exist yet, and create a
Metal3Data object with the index. Upon success, it will set the <em>ready</em> field
to true, and the <em>renderedData</em> field to reference the <em>Metal3Data</em> object.</p>
<p>The Metal3Data reconciler will then generate the secrets, based on the index,
the Metal3DataTemplate and the machine. Once created, it will set the status
field <code>ready</code> to True.</p>
<p>Once the Metal3Data object is ready, the Metal3Machine controller will fetch
the secrets that have been created (one or both) and use them to start
provisioning the BareMetalHost.</p>
<h3><a class="header" href="#hybrid-configuration" id="hybrid-configuration">Hybrid configuration</a></h3>
<p>If the Metal3Machine object is created with a <code>dataTemplate</code> field set, but one
of the <code>metaData</code> or <code>networkData</code> is also set in the spec, this one will
override the template generation for this specific secret. i.e. if the user sets
the three fields, the controller will use the user input secret for both.</p>
<p>This means that some hybrid scenarios are supported, where the user can give
directly the <code>metaData</code> secret and let the controller render the <code>networkData</code>
secret through the Metal3DataTemplate object.</p>
<h1><a class="header" href="#custom-resource-relational-diagram" id="custom-resource-relational-diagram">Custom Resource Relational Diagram</a></h1>
<h1><a class="header" href="#references" id="references">References</a></h1>
<h1><a class="header" href="#glossary" id="glossary">Glossary</a></h1>
<h1><a class="header" href="#code-of-conduct-1" id="code-of-conduct-1">Code of Conduct</a></h1>
<h1><a class="header" href="#contribution" id="contribution">Contribution</a></h1>
<h1><a class="header" href="#roadmap" id="roadmap">Roadmap</a></h1>
<h1><a class="header" href="#multi-repo-test-with-mdbook" id="multi-repo-test-with-mdbook">Multi-repo test with mdbook</a></h1>
<p>============== Test with Mdbook ================</p>
<h1><a class="header" href="#api-and-resource-definitions" id="api-and-resource-definitions">API and Resource Definitions</a></h1>
<h2><a class="header" href="#baremetalhost-2" id="baremetalhost-2">BareMetalHost</a></h2>
<p><strong>Metal³</strong> introduces the concept of <strong>BareMetalHost</strong> resource, which
defines a physical host and its properties. The <strong>BareMetalHost</strong> embeds
two well differentiated sections, the bare metal host specification
and its current status.</p>
<h3><a class="header" href="#pausing-reconciliation" id="pausing-reconciliation">Pausing reconciliation</a></h3>
<p>It is possible to pause the reconciliation of a BareMetalHost object by adding
an annotation <code>baremetalhost.metal3.io/paused</code>. <strong>Metal³</strong>  provider sets the
value of this annotation as <code>metal3.io/capm3</code> when the cluster to which the
<strong>BareMetalHost</strong> belongs, is paused and removes it when the cluster is
not paused. If you want to pause the reconciliation of <strong>BareMetalHost</strong> you can
put any value on this annotation <strong>other than <code>metal3.io/capm3</code></strong>. Please make
sure that you remove the annotation  <strong>only if the value of the annotation is
not <code>metal3.io/capm3</code>, but another value that you have provided</strong>. Removing the
annotation will enable the reconciliation again.</p>
<h3><a class="header" href="#baremetalhost-spec-1" id="baremetalhost-spec-1">BareMetalHost spec</a></h3>
<p>The <em>BareMetalHost’s</em> <em>spec</em> defines the desire state of the host. It contains
mainly, but not only, provisioning details.</p>
<h4><a class="header" href="#spec-fields" id="spec-fields">Spec fields</a></h4>
<ul>
<li>
<p><em>bmc</em> -- The connection information for the BMC (Baseboard Management
Controller) on the host.</p>
<ul>
<li>
<p><em>address</em> -- The URL for communicating with the BMC controller, based
on the provider being used, the URL will look as follows:</p>
<ul>
<li>IPMI
<ul>
<li><code>ipmi://&lt;host&gt;:&lt;port&gt;</code>, an unadorned <code>&lt;host&gt;:&lt;port&gt;</code> is also accepted
and the port is optional, if using the default one (623).</li>
</ul>
</li>
<li>Dell iDRAC
<ul>
<li><code>idrac://</code> (or <code>idrac+http://</code> to disable TLS).</li>
<li><code>idrac-virtualmedia://</code> to use virtual media instead of PXE
for attaching the provisioning image to the host.</li>
</ul>
</li>
<li>Fujitsu iRMC
<ul>
<li><code>irmc://&lt;host&gt;:&lt;port&gt;</code>, where <code>&lt;port&gt;</code> is optional if using the default.</li>
</ul>
</li>
<li>Redfish
<ul>
<li><code>redfish://</code> (or <code>redfish+http://</code> to disable TLS)</li>
<li><code>redfish-virtualmedia://</code> to use virtual media instead of PXE
for attaching the provisioning image to the host.</li>
<li>The hostname or IP address, and the path to the system ID are
required for all variants.  For example
<code>redfish://myhost.example/redfish/v1/Systems/System.Embedded.1</code>
or <code>redfish://myhost.example/redfish/v1/Systems/1</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p><em>credentialsName</em> -- A reference to a <em>secret</em> containing the
username and password for the BMC.</p>
</li>
<li>
<p><em>disableCertificateVerification</em> -- A boolean to skip certificate
validation when true.</p>
</li>
</ul>
</li>
<li>
<p><em>online</em> -- A boolean indicating whether the host should be powered on
(true) or off (false). Changing this value will trigger a change in
power state on the physical host.</p>
</li>
<li>
<p><em>consumerRef</em> -- A reference to another resource that is using the
host, it could be empty if the host is not being currently used.
For example, a <em>Machine</em> resource when the host is being used by the
<a href="https://github.com/kubernetes-sigs/cluster-api"><em>machine-api</em></a>.</p>
</li>
<li>
<p><em>externallyProvisioned</em> -- A boolean indicating whether the host
provisioning and deprovisioning are managed externally. When set,
the host’s power status and hardware inventory will be monitored
but no provisioning or deprovisioning operations are performed
on the host.</p>
</li>
<li>
<p><em>image</em> -- Holds details for the image to be deployed on a given host.</p>
<ul>
<li><em>url</em> -- The URL of an image to deploy to the host.</li>
<li><em>checksum</em> -- The actual checksum or a URL to a file containing
the checksum for the image at <em>image.url</em>.</li>
<li><em>checksumType</em> -- Checksum algorithms can be specified. Currently
only <code>md5</code>, <code>sha256</code>, <code>sha512</code> are recognized. If nothing is specified
<code>md5</code> is assumed.</li>
</ul>
</li>
<li>
<p><em>userData</em> -- A reference to the Secret containing the cloudinit user data
and its namespace, so it can be attached to the host before it boots
for configuring different aspects of the OS (like networking, storage, ...).</p>
</li>
<li>
<p><em>networkData</em> -- A reference to the Secret containing the network
configuration data (e.g. network_data.json) and its namespace, so it can be
attached to the host before it boots to set network up</p>
</li>
<li>
<p><em>description</em> -- A human-provided string to help identify the host.</p>
</li>
</ul>
<h3><a class="header" href="#baremetalhost-status-1" id="baremetalhost-status-1">BareMetalHost status</a></h3>
<p>Moving onto the next block, the <em>BareMetalHost’s</em> <em>status</em> which represents
the host’s current state. Including tested credentials, current hardware
details, etc.</p>
<h4><a class="header" href="#status-fields" id="status-fields">Status fields</a></h4>
<ul>
<li>
<p><em>goodCredentials</em> -- A reference to the secret and its namespace
holding the last set of BMC credentials the system was able to validate
as working.</p>
</li>
<li>
<p><em>triedCredentials</em> -- A reference to the secret and its namespace
holding the last set of BMC credentials that were sent to
the provisioning backend.</p>
</li>
<li>
<p><em>lastUpdated</em> -- The timestamp of the last time the status of the
host was updated.</p>
</li>
<li>
<p><em>operationalStatus</em> -- The status of the server. Value is one of the
following:</p>
<ul>
<li><em>OK</em> -- Indicates all the details for the host are known and working,
meaning the host is correctly configured and manageable.</li>
<li><em>discovered</em> -- Implies some of the host’s details are either
not working correctly or missing. For example, the BMC address is known
but the login credentials are not.</li>
<li><em>error</em> -- Indicates the system found some sort of irrecuperable error.
Refer to the <em>errorMessage</em> field in the status section for more details.</li>
</ul>
</li>
<li>
<p><em>errorMessage</em> -- Details of the last error reported by the provisioning
backend, if any.</p>
</li>
<li>
<p><em>hardware</em> -- The details for hardware capabilities discovered on the
host. These are filled in by the provisioning agent when the host is
registered.</p>
<ul>
<li><em>nics</em> -- List of network interfaces for the host.
<ul>
<li><em>name</em> -- A string identifying the network device,
e.g. <em>nic-1</em>.</li>
<li><em>mac</em> -- The MAC address of the NIC.</li>
<li><em>ip</em> -- The IP address of the NIC, if one was assigned
when the discovery agent ran.</li>
<li><em>speedGbps</em> -- The speed of the device in Gbps.</li>
<li><em>vlans</em> -- A list holding all the VLANs available for this NIC.</li>
<li><em>vlanId</em> -- The untagged VLAN ID.</li>
<li><em>pxe</em> -- Whether the NIC is able to boot using PXE.</li>
</ul>
</li>
<li><em>storage</em> -- List of storage (disk, SSD, etc.) available to the host.
<ul>
<li><em>name</em> -- A string identifying the storage device,
e.g. <em>disk 1 (boot)</em>.</li>
<li><em>rotational</em> -- Either true or false, indicates whether the disk
is rotational.</li>
<li><em>sizeBytes</em> -- Size of the storage device.</li>
<li><em>serialNumber</em> -- The device’s serial number.</li>
</ul>
</li>
<li><em>cpu</em> -- Details of the CPU(s) in the system.
<ul>
<li><em>arch</em> -- The architecture of the CPU.</li>
<li><em>model</em> -- The model string.</li>
<li><em>clockMegahertz</em> -- The speed in GHz of the CPU.</li>
<li><em>flags</em> -- List of CPU flags, e.g. ‘mmx’,’sse’,’sse2’,’vmx’, ...</li>
<li><em>count</em> -- Amount of these CPUs available in the system.</li>
</ul>
</li>
<li><em>firmware</em> -- Contains BIOS information like for instance its <em>vendor</em>
and <em>version</em>.</li>
<li><em>systemVendor</em> -- Contains information about the host’s <em>manufacturer</em>,
the <em>productName</em> and <em>serialNumber</em>.</li>
<li><em>ramMebibytes</em> -- The host’s amount of memory in Mebibytes.</li>
</ul>
</li>
<li>
<p><em>hardwareProfile</em> -- The name of the hardware profile that matches the
hardware discovered on the host. These details are saved
to the <em>Hardware</em> section. If the hardware does not match any
known profile, the value <code>unknown</code> will be set on this field
and is used by default. In practice, this only affects which device
the OS image will be written to. The following are the current
supported <code>hardwareProfile</code> settings and their corresponding root devices.</p>
<table><thead><tr><th><strong>hardwareProfile</strong></th><th><strong>Root Device</strong></th></tr></thead><tbody>
<tr><td><code>unknown</code></td><td>/dev/sda</td></tr>
<tr><td><code>libvirt</code></td><td>/dev/vda</td></tr>
<tr><td><code>dell</code></td><td>HCTL: 0:0:0:0</td></tr>
<tr><td><code>dell-raid</code></td><td>HCTL: 0:2:0:0</td></tr>
<tr><td><code>openstack</code></td><td>/dev/vdb</td></tr>
</tbody></table>
<p><strong>NOTE:</strong> These are subject to change.</p>
</li>
<li>
<p><em>poweredOn</em> -- Boolean indicating whether the host is powered on.
See <em>online</em> on the <em>BareMetalHost’s</em> <em>Spec</em>.</p>
</li>
<li>
<p><em>provisioning</em> -- Settings related to deploying an image to the host.</p>
<ul>
<li><em>state</em> -- The current state of any ongoing provisioning operation.
The following are the currently supported ones:
<ul>
<li><em>&lt;empty string&gt;</em> -- There is no provisioning happening, at the moment.</li>
<li><em>registration error</em> -- The details for the host’s BMC are
either incorrect or incomplete therfore the host could not be managed.</li>
<li><em>registering</em> -- The host’s BMC details are being checked.</li>
<li><em>match profile</em> -- The discovered hardware details on the host
are being compared against known profiles.</li>
<li><em>ready</em> -- The host is available to be consumed.</li>
<li><em>provisioning</em> -- An image is being written to the host’s disk(s).</li>
<li><em>provisioning error</em> -- The image could not be written to the host.</li>
<li><em>provisioned</em> -- An image has been completely written to the host’s
disk(s).</li>
<li><em>externally provisioned</em> -- Metal³ does not manage the image on the host.</li>
<li><em>deprovisioning</em> -- The image is being wiped from the host’s disk(s).</li>
<li><em>inspecting</em> -- The hardware details for the host are being collected
by an agent.</li>
<li><em>power management error</em> -- An error was found while trying to power
the host either on or off.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3><a class="header" href="#baremetalhost-example-1" id="baremetalhost-example-1">BareMetalHost Example</a></h3>
<p>The following is a complete example from a running cluster of a <em>BareMetalHost</em>
resource (in YAML), it includes its specification and status sections:</p>
<pre><code class="language-yaml">apiVersion: metal3.io/v1alpha1
kind: BareMetalHost
metadata:
  creationTimestamp: &quot;2019-09-20T06:33:35Z&quot;
  finalizers:
  - baremetalhost.metal3.io
  generation: 2
  name: bmo-master-0
  namespace: bmo-project
  resourceVersion: &quot;22642&quot;
  selfLink: /apis/metal3.io/v1alpha1/namespaces/bmo-project/baremetalhosts/bmo-master-0
  uid: 92b2f77a-db70-11e9-9db1-525400764849
spec:
  bmc:
    address: ipmi://10.10.57.19
    credentialsName: bmo-master-0-bmc-secret
  bootMACAddress: 98:03:9b:61:80:48
  consumerRef:
    apiVersion: machine.openshift.io/v1beta1
    kind: Machine
    name: bmo-master-0
    namespace: bmo-project
  externallyProvisioned: true
  hardwareProfile: default
  image:
    checksum: http://172.16.1.100/images/myOSv1/myOS.qcow2.md5sum
    url: http://172.16.1.100/images/myOSv1/myOS.qcow2
  online: true
  userData:
    name: bmo-master-user-data
    namespace: bmo-project
  networkData:
    name: bmo-master-network-data
    namespace: bmo-project
  metaData:
    name: bmo-master-meta-data
    namespace: bmo-project
status:
  errorMessage: &quot;&quot;
  goodCredentials:
    credentials:
      name: bmo-master-0-bmc-secret
      namespace: bmo-project
    credentialsVersion: &quot;5562&quot;
  hardware:
    cpu:
      arch: x86_64
      clockMegahertz: 2000
      count: 40
      flags: []
      model: Intel(R) Xeon(R) Gold 6138 CPU @ 2.00GHz
    firmware:
      bios:
        date: 12/17/2018
        vendor: Dell Inc.
        version: 1.6.13
    hostname: bmo-master-0.localdomain
    nics:
    - ip: 172.22.135.105
      mac: &quot;00:00:00:00:00:00&quot;
      model: unknown
      name: eno1
      pxe: true
      speedGbps: 25
      vlanId: 0
    ramMebibytes: 0
    storage: []
    systemVendor:
      manufacturer: Dell Inc.
      productName: PowerEdge r460
      serialNumber: &quot;&quot;
  hardwareProfile: &quot;&quot;
  lastUpdated: &quot;2019-09-20T07:03:23Z&quot;
  operationalStatus: OK
  poweredOn: true
  provisioning:
    ID: a4438010-3fc6-4c5c-b570-900bbe85da57
    image:
      checksum: &quot;&quot;
      url: &quot;&quot;
    state: externally provisioned
  triedCredentials:
    credentials:
      name: bmo-master-0-bmc-secret
      namespace: bmo-project
    credentialsVersion: &quot;5562&quot;
</code></pre>
<p>And here it is the secret <code>bmo-master-0-bmc-secret</code> holding the host’s BMC credentials:</p>
<pre><code class="language-yaml">---
apiVersion: v1
kind: Secret
metadata:
  name: bmo-master-0-bmc-secret
type: Opaque
data:
  username: YWRtaW4=
  password: cGFzc3dvcmQ=
</code></pre>
<h2><a class="header" href="#triggering-provisioning" id="triggering-provisioning">Triggering Provisioning</a></h2>
<p>Several conditions must be met in order to initiate provisioning.</p>
<ol>
<li>The host <code>spec.image.url</code> field must contain a URL for a valid
image file that is visible from within the cluster and from the
host receiving the image.</li>
<li>The host must have <code>online</code> set to <code>true</code> so that the operator will
keep the host powered on.</li>
</ol>
<p>To initiate deprovisioning, clear the image URL from the host spec.</p>
<h1><a class="header" href="#api-and-resource-definitions-1" id="api-and-resource-definitions-1">API and Resource Definitions</a></h1>
<p>This describes a setup where the following Cluster API core components and
Metal3-io components are deployed :</p>
<ul>
<li>Cluster API manager</li>
<li>Cluster API Bootstrap Provider Kubeadm (CABPK) manager</li>
<li>Cluster API Kubeadm Control Plane manager</li>
<li>Baremetal Operator (including the Ironic setup)</li>
<li>Cluster API Provider Metal3 (CAPM3)</li>
</ul>
<h2><a class="header" href="#baremetalhost-3" id="baremetalhost-3">BareMetalHost</a></h2>
<p>The BareMetalHost is an object from
<a href="https://github.com/metal3-io/baremetal-operator">baremetal-operator</a>. Each
CR represents a physical host with BMC credentials, hardware status etc.</p>
<p>BareMetalHost exposes those different fields that are secret references:</p>
<ul>
<li><strong>userData</strong> : for a cloud-init user-data in a secret with the key <code>userData</code></li>
<li><strong>metaData</strong> : for a cloud-init metadata in a secret with the key <code>metaData</code></li>
<li><strong>networkData</strong> : for a cloud-init network data in a secret with the key
<code>networkData</code></li>
</ul>
<p>For the metaData, soome values are set by default to maintain compatibility:</p>
<ul>
<li><strong>uuid</strong>: This is the BareMetalHost UID</li>
<li><strong>metal3-namespace</strong>: the name of the BareMetalHost</li>
<li><strong>metal3-name</strong>: The name of the BareMetalHost</li>
<li><strong>local-hostname</strong>: The name of the BareMetalHost</li>
<li><strong>local_hostname</strong>: The namespace of the BareMetalHost</li>
</ul>
<p>However, setting any of those values in the metaData secret will override those
default values.</p>
<h3><a class="header" href="#unhealthy-annotation" id="unhealthy-annotation">Unhealthy annotation</a></h3>
<p>In CAPM3 v1alpha4 it is possible to mark BareMetalHost object as unhealthy by adding an
annotation <code>capi.metal3.io/unhealthy</code>. This annotation prevents CAPM3 to select
unhealthy BareMetalHost for newly created metal3machine. Removing the annotation
will enable the normal operations.</p>
<h2><a class="header" href="#cluster" id="cluster">Cluster</a></h2>
<p>A Cluster is a Cluster API core object representing a Kubernetes cluster.</p>
<p>Example cluster:</p>
<pre><code class="language-yaml">apiVersion: cluster.x-k8s.io/v1alpha3
kind: Cluster
metadata:
  name: cluster
spec:
  clusterNetwork:
    services:
      cidrBlocks: [&quot;10.96.0.0/12&quot;]
    pods:
      cidrBlocks: [&quot;192.168.0.0/18&quot;]
    serviceDomain: &quot;cluster.local&quot;
  infrastructureRef:
    apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
    kind: Metal3Cluster
    name: m3cluster
  controlPlaneRef:
    kind: KubeadmControlPlane
    apiVersion: controlplane.cluster.x-k8s.io/v1alpha3
    name: m3cluster-controlplane
</code></pre>
<h2><a class="header" href="#metal3cluster-1" id="metal3cluster-1">Metal3Cluster</a></h2>
<p>The metal3Cluster object contains information related to the deployment of
the cluster on Baremetal. It currently has two specification fields :</p>
<ul>
<li><strong>controlPlaneEndpoint</strong>: contains the target cluster API server address and
port</li>
<li><strong>noCloudProvider</strong>: (true/false) Whether the cluster will not be deployed
with an external cloud provider. If set to true, CAPM3 will patch the target
cluster node objects to add a providerID. This will allow the CAPI process to
continue even if the cluster is deployed without cloud provider.</li>
</ul>
<p>Example metal3cluster :</p>
<pre><code class="language-yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
kind: Metal3Cluster
metadata:
  name: m3cluster
spec:
 controlPlaneEndpoint:
   host: 192.168.111.249
   port: 6443
 noCloudProvider: true
</code></pre>
<h2><a class="header" href="#kubeadmcontrolplane" id="kubeadmcontrolplane">KubeadmControlPlane</a></h2>
<p>This object contains all information related to the control plane configuration.
It references an <strong>infrastructureTemplate</strong> that must be a
<em>Metal3MachineTemplate</em> in this case.</p>
<p>For example:</p>
<pre><code class="language-yaml">kind: KubeadmControlPlane
apiVersion: controlplane.cluster.x-k8s.io/v1alpha3
metadata:
  name: m3cluster-controlplane
spec:
  replicas: 3
  version: v1.17.0
  infrastructureTemplate:
    kind: Metal3MachineTemplate
    apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
    name: m3cluster-controlplane
  kubeadmConfigSpec:
    initConfiguration:
      nodeRegistration:
        name: 'host0'
        kubeletExtraArgs:
          cloud-provider: baremetal
    clusterConfiguration:
      apiServer:
        extraArgs:
          cloud-provider: baremetal
      controllerManager:
        extraArgs:
          cloud-provider: baremetal
    joinConfiguration:
      controlPlane: {}
      nodeRegistration:
        name: 'host0'
        kubeletExtraArgs:
          cloud-provider: baremetal
</code></pre>
<h2><a class="header" href="#kubeadmconfig" id="kubeadmconfig">KubeadmConfig</a></h2>
<p>The KubeadmConfig object is for CABPK. It contains the node Kubeadm
configuration and additional commands to run on the node for the setup.</p>
<p>In order to deploy Kubernetes successfully, you need to know the cluster API
address before deployment. However, if you are deploying an HA cluster or if you
are deploying without using static ip addresses, the cluster API server address
is unknown. A solution to go around the problem is to deploy Keepalived.
Keepalived allows you to set up a virtual IP, defined beforehand, and shared
by the nodes. Hence the commands to set up Keepalived have to run before
kubeadm.</p>
<p>The content of a KubeadmConfig can contain Jinja2 template elements, since the
cloud-init renders the cloud-config as a Jinja2 template. It is possible to
use metadata from cloud-init, using the following: <code>{{ ds.meta_data.&lt;key&gt;}}</code>.
The keys and values are passed to cloud-init through a <code>Metal3DataTemplate</code>
object (see below).</p>
<p>Example KubeadmConfig:</p>
<pre><code class="language-yaml">apiVersion: bootstrap.cluster.x-k8s.io/v1alpha3
kind: KubeadmConfig
metadata:
  name: controlplane-0
spec:
  initConfiguration:
    nodeRegistration:
      name: '{{ ds.meta_data.name }}'
      kubeletExtraArgs:
        node-labels: 'metal3.io/uuid={{ ds.meta_data.uuid }}'
  preKubeadmCommands:
    - apt update -y
    - apt install net-tools -y
    - apt install -y gcc linux-headers-$(uname -r)
    - apt install -y keepalived
    - systemctl start keepalived
    - systemctl enable keepalived
    - &gt;-
      apt install apt-transport-https ca-certificates curl gnupg-agent
      software-properties-common -y
    - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
    - &gt;-
      add-apt-repository &quot;deb [arch=amd64]
      https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable&quot;
    - apt update -y
    - apt install docker-ce docker-ce-cli containerd.io -y
    - usermod -aG docker ubuntu
    - &gt;-
      curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg
      | apt-key add -
    - &gt;-
      echo 'deb https://apt.kubernetes.io/ kubernetes-xenial main'
      &gt; /etc/apt/sources.list.d/kubernetes.list
    - apt update
    - apt install -y kubelet kubeadm kubectl
    - systemctl enable --now kubelet
  postKubeadmCommands:
    - mkdir -p /home/ubuntu/.kube
    - cp /etc/kubernetes/admin.conf /home/ubuntu/.kube/config
    - chown ubuntu:ubuntu /home/ubuntu/.kube/config
  files:
      - path: /etc/keepalived/keepalived.conf
        content: |
          ! Configuration File for keepalived
          global_defs {
              notification_email {
              sysadmin@example.com
              support@example.com
              }
              notification_email_from lb@example.com
              smtp_server localhost
              smtp_connect_timeout 30
          }
          vrrp_instance VI_1 {
              state MASTER
              interface enp2s0
              virtual_router_id 1
              priority 101
              advert_int 1
              virtual_ipaddress {
                  192.168.111.249
              }
          }
</code></pre>
<h2><a class="header" href="#machine" id="machine">Machine</a></h2>
<p>A Machine is a Cluster API core object representing a Kubernetes node. A machine
has a reference to a KubeadmConfig and a reference to a metal3machine.</p>
<p>Example Machine:</p>
<pre><code class="language-yaml">apiVersion: cluster.x-k8s.io/v1alpha3
kind: Machine
metadata:
  name: controlplane-0
  labels:
    cluster.x-k8s.io/control-plane: &quot;true&quot;
    cluster.x-k8s.io/cluster-name: &quot;cluster&quot;
spec:
  version: 1.16
  bootstrap:
    configRef:
      apiVersion: bootstrap.cluster.x-k8s.io/v1alpha3
      kind: KubeadmConfig
      name: controlplane-0
  infrastructureRef:
    apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
    kind: Metal3Machine
    name: controlplane-0
</code></pre>
<h2><a class="header" href="#metal3machine-1" id="metal3machine-1">Metal3Machine</a></h2>
<p>The Metal3Machine contains information related to the deployment of the
BareMetalHost such as the image and the host selector. For each machine, there
must be a Metal3Machine.</p>
<p>The fields are :</p>
<ul>
<li>
<p><strong>image</strong> -- This includes two sub-fields, <code>url</code> and <code>checksum</code>, which
include the URL to the image and the URL to a checksum for that image. These
fields are required. The image will be used for provisioning of the
<code>BareMetalHost</code> chosen by the <code>Machine</code> actuator.</p>
</li>
<li>
<p><strong>userData</strong> -- This includes two sub-fields, <code>name</code> and <code>namespace</code>, which
reference a <code>Secret</code> that contains base64 encoded user-data to be written to
a config drive on the provisioned <code>BareMetalHost</code>. This field is optional and
is automatically set by CAPM3 with the userData from the machine object. If
you want to overwrite the userData, this should be done in the CAPI machine.</p>
</li>
<li>
<p><strong>dataTemplate</strong> -- This includes a reference to a Metal3DataTemplate object
containing the metadata and network data templates, and includes two fields,
<code>name</code> and <code>namespace</code>.</p>
</li>
<li>
<p><strong>metaData</strong> is a reference to a secret containing the metadata rendered from
the Metal3DataTemplate metadata template object automatically. In case this
would not be managed by the Metal3DataTemplate controller, if provided by the
user for example, the ownerreference should be set properly to ensure that the
secret belongs to the cluster ownerReference tree (see
<a href="https://cluster-api.sigs.k8s.io/clusterctl/provider-contract.html#ownerreferences-chain">doc</a>).</p>
</li>
<li>
<p><strong>networkData</strong> is a reference to a secret containing the network data
rendered from the Metal3DataTemplate metadata template object automatically.
In case this would not be managed by the Metal3DataTemplate controller, if
provided by the user for example, the ownerreference should be set properly to
ensure that the secret belongs to the cluster ownerReference tree (see
<a href="https://cluster-api.sigs.k8s.io/clusterctl/provider-contract.html#ownerreferences-chain">doc</a>).
The content of the secret should be a yaml equivalent of a json object that
follows the format definition that can be found
<a href="https://docs.openstack.org/nova/latest/_downloads/9119ca7ac90aa2990e762c08baea3a36/network_data.json">here</a>.</p>
</li>
<li>
<p><strong>hostSelector</strong> -- Specify criteria for matching labels on <code>BareMetalHost</code>
objects. This can be used to limit the set of available <code>BareMetalHost</code>
objects chosen for this <code>Machine</code>.</p>
</li>
</ul>
<p>The <code>metaData</code> and <code>networkData</code> field in the <code>spec</code> section are for the user
to give directly a secret to use as metaData or networkData. The <code>userData</code>,
<code>metaData</code> and <code>networkData</code> fields in the <code>status</code> section are for the
controller to store the reference to the secret that is actually being used,
whether it is from one of the spec fields, or somehow generated. This is aimed
at making a clear difference between the desired state from the user (whether
it is with a DataTemplate reference, or direct <code>metaData</code> or <code>userData</code> secrets)
and what the controller is actually using.</p>
<p>The <code>dataTemplate</code> field consists of an object reference to a
Metal3DataTemplate object containing the templates for the metadata and
network data generation for this Metal3Machine. The <code>renderedData</code> field is a
reference to the Metal3Data object created for this machine. If the
dataTemplate field is set but either the <code>renderedData</code>, <code>metaData</code> or
<code>networkData</code> fields in the status are unset, then the Metal3Machine
controller will wait until it can find the Metal3Data object and the rendered
secrets. It will then populate those fields.</p>
<p>When CAPM3 controller will set the different fields in the BareMetalHost,
it will reference the metadata secret and the network data secret
in the BareMetalHost. If any of the <code>metaData</code> or <code>networkData</code> status fields
are unset, that field will also remain unset on the BareMetalHost.</p>
<p>When the Metal3Machine gets deleted, the CAPM3 controller will remove its
ownerreference from the data template object. This will trigger the deletion of
the generated Metal3Data object and the secrets generated for this machine.</p>
<h3><a class="header" href="#hostselector-examples" id="hostselector-examples">hostSelector Examples</a></h3>
<p>The `hostSelector field has two possible optional sub-fields:</p>
<ul>
<li>
<p><strong>matchLabels</strong> -- Key/value pairs of labels that must match exactly.</p>
</li>
<li>
<p><strong>matchExpressions</strong> -- A set of expressions that must evaluate to true for
the labels on a <code>BareMetalHost</code>.</p>
</li>
</ul>
<p>Valid operators include:</p>
<ul>
<li><strong>!</strong> -- Key does not exist. Values ignored.</li>
<li><strong>=</strong> -- Key equals specified value. There must only be one
value specified.</li>
<li><strong>==</strong> -- Key equals specified value. There must only be one
value specified.</li>
<li><strong>in</strong> -- Value is a member of a set of possible values</li>
<li><strong>!=</strong> -- Key does not equal the specified value. There must
only be one value specified.</li>
<li><strong>notin</strong> -- Value not a member of the specified set of values.</li>
<li><strong>exists</strong> -- Key exists. Values ignored.</li>
<li><strong>gt</strong> -- Value is greater than the one specified. Value must be
an integer.</li>
<li><strong>lt</strong> -- Value is less than the one specified. Value must be
an integer.</li>
</ul>
<p>Example 1: Only consider a <code>BareMetalHost</code> with label <code>key1</code> set to <code>value1</code>.</p>
<pre><code class="language-yaml">spec:
  providerSpec:
    value:
      hostSelector:
        matchLabels:
          key1: value1
</code></pre>
<p>Example 2: Only consider <code>BareMetalHost</code> with both <code>key1</code> set to <code>value1</code> AND
<code>key2</code> set to <code>value2</code>.</p>
<pre><code class="language-yaml">spec:
  providerSpec:
    value:
      hostSelector:
        matchLabels:
          key1: value1
          key2: value2
</code></pre>
<p>Example 3: Only consider <code>BareMetalHost</code> with <code>key3</code> set to either <code>a</code>, <code>b</code>, or
<code>c</code>.</p>
<pre><code class="language-yaml">spec:
  providerSpec:
    value:
      hostSelector:
        matchExpressions:
          - key: key3
            operator: in
            values: [‘a’, ‘b’, ‘c’]
</code></pre>
<p>Example 3: Only consider <code>BareMetalHost</code> with <code>key1</code> set to <code>value1</code> AND <code>key2</code>
set to <code>value2</code> AND <code>key3</code> set to either <code>a</code>, <code>b</code>, or <code>c</code>.</p>
<pre><code class="language-yaml">spec:
  providerSpec:
    value:
      hostSelector:
        matchLabels:
          key1: value1
          key2: value2
        matchExpressions:
          - key: key3
            operator: in
            values: [‘a’, ‘b’, ‘c’]
</code></pre>
<h3><a class="header" href="#metal3machine-example-1" id="metal3machine-example-1">Metal3Machine example</a></h3>
<pre><code class="language-yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
kind: Metal3Machine
metadata:
  name: controlplane-0
spec:
  image:
    url: https://cloud-images.ubuntu.com/bionic/current/bionic-server-cloudimg-amd64.img
    checksum: https://cloud-images.ubuntu.com/bionic/current/bionic-server-cloudimg-amd64.img.md5sum
  hostSelector:
    matchLabels:
      key1: value1
    matchExpressions:
      key: key2
      operator: in
      values: {‘abc’, ‘123’, ‘value2’}
  dataTemplate:
    Name: controlplane-metadata
  metaData:
    Name: controlplane-0-metadata-0
</code></pre>
<h2><a class="header" href="#machinedeployment" id="machinedeployment">MachineDeployment</a></h2>
<p>MachineDeployment is a core Cluster API object that is similar to
deployment for pods. It refers to a KubeadmConfigTemplate and to a
Metal3MachineTemplate.</p>
<p>Example MachineDeployment:</p>
<pre><code class="language-yaml">apiVersion: cluster.x-k8s.io/v1alpha3
kind: MachineDeployment
metadata:
  name: md-0
  labels:
    cluster.x-k8s.io/cluster-name: cluster
    nodepool: nodepool-0
spec:
  replicas: 1
  selector:
    matchLabels:
      cluster.x-k8s.io/cluster-name: cluster
      nodepool: nodepool-0
  template:
    metadata:
      labels:
        cluster.x-k8s.io/cluster-name: cluster
        nodepool: nodepool-0
    spec:
      version: 1.16
      bootstrap:
        configRef:
          name: md-0
          apiVersion: bootstrap.cluster.x-k8s.io/v1alpha3
          kind: KubeadmConfigTemplate
      infrastructureRef:
        name: md-0
        apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
        kind: Metal3MachineTemplate
</code></pre>
<h2><a class="header" href="#kubeadmconfigtemplate" id="kubeadmconfigtemplate">KubeadmConfigTemplate</a></h2>
<p>This contains a template to generate KubeadmConfig.</p>
<p>Example KubeadmConfigTemplate:</p>
<pre><code class="language-yaml">apiVersion: bootstrap.cluster.x-k8s.io/v1alpha3
kind: KubeadmConfigTemplate
metadata:
  name: md-0
spec:
  template:
    spec:
      joinConfiguration:
        nodeRegistration:
          name: '{{ ds.meta_data.name }}'
          kubeletExtraArgs:
            node-labels: 'metal3.io/uuid={{ ds.meta_data.uuid }}'
      preKubeadmCommands:
        - apt update -y
        - &gt;-
          apt install apt-transport-https ca-certificates curl gnupg-agent
          software-properties-common -y
        - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
        - &gt;-
          add-apt-repository &quot;deb [arch=amd64]
          https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable&quot;
        - apt update -y
        - apt install docker-ce docker-ce-cli containerd.io -y
        - usermod -aG docker ubuntu
        - &gt;-
          curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg
          | apt-key add -
        - &gt;-
          echo 'deb https://apt.kubernetes.io/ kubernetes-xenial main'
          &gt; /etc/apt/sources.list.d/kubernetes.list
        - apt update
        - apt install -y kubelet kubeadm kubectl
        - systemctl enable --now kubelet
</code></pre>
<h2><a class="header" href="#metal3machinetemplate-1" id="metal3machinetemplate-1">Metal3MachineTemplate</a></h2>
<p>The Metal3MachineTemplate contains the template to create Metal3Machine.</p>
<p>Example Metal3MachineTemplate :</p>
<pre><code class="language-yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
kind: Metal3MachineTemplate
metadata:
  name: md-0
spec:
  template:
    spec:
      image:
        url: https://cloud-images.ubuntu.com/bionic/current/bionic-server-cloudimg-amd64.img
        checksum: https://cloud-images.ubuntu.com/bionic/current/bionic-server-cloudimg-amd64.img.md5sum
      hostSelector:
        matchLabels:
          key1: value1
        matchExpressions:
          key: key2
          operator: in
          values: {‘abc’, ‘123’, ‘value2’}
      dataTemplate:
        Name: md-0-metadata
</code></pre>
<h2><a class="header" href="#metal3datatemplate-1" id="metal3datatemplate-1">Metal3DataTemplate</a></h2>
<pre><code class="language-yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
kind: Metal3DataTemplate
metadata:
  name: nodepool-1
  namespace: default
  ownerReferences:
  - apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
    controller: true
    kind: Metal3Cluster
    name: cluster-1
spec:
  metaData:
    strings:
      - key: abc
        value: def
    objectNames:
      - key: name_m3m
        object: metal3machine
      - key: name_machine
        object: machine
      - key: name_bmh
        object: baremetalhost
    indexes:
      - key: index
        offset: 0
        step: 1
    ipAddressesFromIPPool:
      - key: ip
        Name: pool-1
    prefixesFromIPPool:
      - key: ip
        Name: pool-1
    gatewaysFromIPPool:
      - key: gateway
        Name: pool-1
    dnsServersFromIPPool:
      - key: dns
        Name: pool-1
    fromHostInterfaces:
      - key: mac
        interface: &quot;eth0&quot;
    fromLabels:
      - key: label-1
        object: machine
        label: mylabelkey
    fromAnnotations:
      - key: annotation-1
        object: machine
        annotation: myannotationkey
  networkData:
    links:
      ethernets:
        - type: &quot;phy&quot;
          id: &quot;enp1s0&quot;
          mtu: 1500
          macAddress:
            fromHostInterface: &quot;eth0&quot;
        - type: &quot;phy&quot;
          id: &quot;enp2s0&quot;
          mtu: 1500
          macAddress:
            fromHostInterface: &quot;eth1&quot;
      bonds:
        - id: &quot;bond0&quot;
          mtu: 1500
          macAddress:
            string: &quot;XX:XX:XX:XX:XX:XX&quot;
          bondMode: &quot;802.1ad&quot;
          bondLinks:
            - enp1s0
            - enp2s0
      vlans:
        - id: &quot;vlan1&quot;
          mtu: 1500
          macAddress:
            string: &quot;YY:YY:YY:YY:YY:YY&quot;
          vlanId: 1
          vlanLink: bond0
    networks:
      ipv4DHCP:
        - id: &quot;provisioning&quot;
          link: &quot;bond0&quot;

      ipv4:
        - id: &quot;Baremetal&quot;
          link: &quot;vlan1&quot;
          IPAddressFromIPPool: pool-1
          routes:
            - network: &quot;0.0.0.0&quot;
              netmask: 0
              gateway:
                fromIPPool: pool-1
              services:
                dns:
                  - &quot;8.8.4.4&quot;
                dnsFromIPPool: pool-1
      ipv6DHCP:
        - id: &quot;provisioning6&quot;
          link: &quot;bond0&quot;
      ipv6SLAAC:
        - id: &quot;provisioning6slaac&quot;
          link: &quot;bond0&quot;
      ipv6:
        - id: &quot;Baremetal6&quot;
          link: &quot;vlan1&quot;
          IPAddressFromIPPool: pool6-1
          routes:
            - network: &quot;0::0&quot;
              netmask: 0
              gateway:
                string: &quot;2001:0db8:85a3::8a2e:0370:1&quot;
              services:
                dns:
                  - &quot;2001:4860:4860::8844&quot;
                dnsFromIPPool: pool6-1
    services:
      dns:
        - &quot;8.8.8.8&quot;
        - &quot;2001:4860:4860::8888&quot;
status:
  indexes:
    &quot;0&quot;: &quot;machine-1&quot;
  dataNames:
    &quot;machine-1&quot;: nodepool-1-0
  lastUpdated: &quot;2020-04-02T06:36:09Z&quot;
</code></pre>
<p>This object will be reconciled by its own controller. When reconciled,
the controller will add a label pointing to the Metal3Cluster that has nodes
linking to this object. The spec contains a <code>metaData</code> and a <code>networkData</code> field
that contain a template of the values that will be rendered for all nodes.</p>
<p>The <code>metaData</code> field will be rendered into a map of strings in yaml format,
while <code>networkData</code> will be rendered into a map equivalent of
<a href="https://docs.openstack.org/nova/latest/user/metadata.html#openstack-format-metadata">Nova network_data.json</a>.
On the target node, the network data will be rendered as a json object that
follows the format definition that can be found
<a href="https://docs.openstack.org/nova/latest/_downloads/9119ca7ac90aa2990e762c08baea3a36/network_data.json">here</a>.</p>
<h3><a class="header" href="#metadata-specifications" id="metadata-specifications">Metadata Specifications</a></h3>
<p>The <code>metaData</code> field contains a list of items that will render data in different
ways. The following types of objects are available and accept lists:</p>
<ul>
<li><strong>strings</strong>: renders the given string as value in the metadata. It takes a
<code>value</code> attribute.</li>
<li><strong>objectNames</strong> : renders the name of the object that matches the type given.
It takes an <code>object</code> attribute, containing the type of the object.</li>
<li><strong>indexes</strong>: renders the index of the current object, with the offset from the
<code>offset</code> field and using the step from the <code>step</code> field. The following
conditions must be matched : <code>offset</code> &gt;= 0 and <code>step</code> &gt;= 1
if the step is unspecified (default value being 0), the controller will
automatically change it for 1. The <code>prefix</code> and <code>suffix</code> attributes are to
provide a prefix and a suffix for the rendered index.</li>
<li><strong>ipAddressesFromIPPool</strong>: renders an ip address from an <em>IPPool</em>
object. The <em>IPPool</em> objects are defined in the
<a href="https://github.com/metal3-io/ip-address-manager">IP Address manager repo</a></li>
<li><strong>prefixesFromIPPool</strong>: renders a network prefix from an <em>IPPool</em>
object. The <em>IPPool</em> objects are defined in the
<a href="https://github.com/metal3-io/ip-address-manager">IP Address manager repo</a></li>
<li><strong>gatewaysFromIPPool</strong>: renders a network gateway from an <em>IPPool</em>
object. The <em>IPPool</em> objects are defined in the
<a href="https://github.com/metal3-io/ip-address-manager">IP Address manager repo</a></li>
<li><strong>dnsServersFromIPPool</strong>: renders a dns servers list from an <em>IPPool</em>
object. The <em>IPPool</em> objects are defined in the
<a href="https://github.com/metal3-io/ip-address-manager">IP Address manager repo</a></li>
<li><strong>fromHostInterfaces</strong>: renders the MAC address of the BareMetalHost that
matches the name given as value.</li>
<li><strong>fromLabels</strong>: renders the content of a label on an object or an empty string
if the label is absent. It takes an <code>object</code> attribute to specify the type of
the object where to fetch the label, and a <code>label</code> attribute that contains the
label key.</li>
<li><strong>fromAnnotations</strong>: renders the content of a annotation on an object or an
empty string if the annotation is absent. It takes an <code>object</code> attribute to
specify the type of the object where to fetch the annotation, and an
<code>annotation</code> attribute that contains the annotation key.</li>
</ul>
<p>For each object, the attribute <strong>key</strong> is required.</p>
<h3><a class="header" href="#networkdata-specifications" id="networkdata-specifications">networkData specifications</a></h3>
<p>The <code>networkData</code> field will contain three items :</p>
<ul>
<li><strong>links</strong>: a list of layer 2 interface</li>
<li><strong>networks</strong>: a list of layer 3 networks</li>
<li><strong>services</strong> : a list of services (DNS)</li>
</ul>
<h4><a class="header" href="#links-specifications-1" id="links-specifications-1">Links specifications</a></h4>
<p>The object for the <strong>links</strong> section list can be:</p>
<ul>
<li><strong>ethernets</strong>: a list of ethernet interfaces</li>
<li><strong>bonds</strong>: a list of bond interfaces</li>
<li><strong>vlans</strong>: a list of vlan interfaces</li>
</ul>
<p>The <strong>links/ethernets</strong> objects contain the following:</p>
<ul>
<li><strong>type</strong>: Type of the ethernet interface</li>
<li><strong>id</strong>: Interface name</li>
<li><strong>mtu</strong>: Interface MTU</li>
<li><strong>macAddress</strong>: an object to render the MAC Address</li>
</ul>
<p>The <strong>links/ethernets/type</strong> can be one of :</p>
<ul>
<li>bridge</li>
<li>dvs</li>
<li>hw_veb</li>
<li>hyperv</li>
<li>ovs</li>
<li>tap</li>
<li>vhostuser</li>
<li>vif</li>
<li>phy</li>
</ul>
<p>The <strong>links/ethernets/macAddress</strong> object can be one of:</p>
<ul>
<li><strong>string</strong>: with the desired Mac given as a string</li>
<li><strong>fromHostInterface</strong>: with the interface name from BareMetalHost
hardware details.</li>
</ul>
<p>The <strong>links/bonds</strong> object contains the following:</p>
<ul>
<li><strong>id</strong>: Interface name</li>
<li><strong>mtu</strong>: Interface MTU</li>
<li><strong>macAddress</strong>: an object to render the MAC Address</li>
<li><strong>bondMode</strong>: The bond mode</li>
<li><strong>bondLinks</strong> : a list of links to use for the bond</li>
</ul>
<p>The <strong>links/bonds/bondMode</strong> can be one of :</p>
<ul>
<li>802.1ad</li>
<li>balance-rr</li>
<li>active-backup</li>
<li>balance-xor</li>
<li>broadcast</li>
<li>balance-tlb</li>
<li>balance-alb</li>
</ul>
<p>The <strong>links/vlans</strong> object contains the following:</p>
<ul>
<li><strong>id</strong>: Interface name</li>
<li><strong>mtu</strong>: Interface MTU</li>
<li><strong>macAddress</strong>: an object to render the MAC Address</li>
<li><strong>vlanId</strong>: The vlan ID</li>
<li><strong>vlanLink</strong> : The link on which to create the vlan</li>
</ul>
<h4><a class="header" href="#the-networks-specifications-1" id="the-networks-specifications-1">The networks specifications</a></h4>
<p>The object for the <strong>networks</strong> section can be:</p>
<ul>
<li><strong>ipv4</strong>: a list of ipv4 static allocations</li>
<li><strong>ipv4DHCP</strong>: a list of ipv4 DHCP based allocations</li>
<li><strong>ipv6</strong>: a list of ipv6 static allocations</li>
<li><strong>ipv6DHCP</strong>: a list of ipv6 DHCP based allocations</li>
<li><strong>ipv6SLAAC</strong>: a list of ipv6 SLAAC based allocations</li>
</ul>
<p>The <strong>networks/ipv4</strong> object contains the following:</p>
<ul>
<li><strong>id</strong>: the network name</li>
<li><strong>link</strong>: The name of the link to configure this network for</li>
<li><strong>ipAddressFromIPPool</strong>: renders an ip address from an <em>IPPool</em>
object. The <em>IPPool</em> objects are defined in the
<a href="https://github.com/metal3-io/ip-address-manager">IP Address manager repo</a></li>
<li><strong>routes</strong>: the list of route objects</li>
</ul>
<p>The <em><em>networks/ipv</em>/routes</em>* is a route object containing:</p>
<ul>
<li><strong>network</strong>: the subnet to reach</li>
<li><strong>netmask</strong>: the mask of the subnet as integer</li>
<li><strong>gateway</strong>: the gateway to use, it can either be given as a string in
<em>string</em> or as an IPPool name in <em>fromIPPool</em></li>
<li><strong>services</strong>: a list of services object as defined later</li>
</ul>
<p>The <strong>networks/ipv4Dhcp</strong> object contains the following:</p>
<ul>
<li><strong>id</strong>: the network name</li>
<li><strong>link</strong>: The name of the link to configure this network for</li>
<li><strong>routes</strong>: the list of route objects</li>
</ul>
<p>The <strong>networks/ipv6</strong> object contains the following:</p>
<ul>
<li><strong>id</strong>: the network name</li>
<li><strong>link</strong>: The name of the link to configure this network for</li>
<li><strong>ipAddressFromIPPool</strong>: renders an ip address from an <em>IPPool</em>
object. The <em>IPPool</em> objects are defined in the
<a href="https://github.com/metal3-io/ip-address-manager">IP Address manager repo</a></li>
<li><strong>routes</strong>: the list of route objects</li>
</ul>
<p>The <strong>networks/ipv6Dhcp</strong> object contains the following:</p>
<ul>
<li><strong>id</strong>: the network name</li>
<li><strong>link</strong>: The name of the link to configure this network for</li>
<li><strong>routes</strong>: the list of route objects</li>
</ul>
<p>The <strong>networks/ipv6Slaac</strong> object contains the following:</p>
<ul>
<li><strong>id</strong>: the network name</li>
<li><strong>link</strong>: The name of the link to configure this network for</li>
<li><strong>routes</strong>: the list of route objects</li>
</ul>
<h4><a class="header" href="#the-services-specifications-1" id="the-services-specifications-1">the services specifications</a></h4>
<p>The object for the <strong>services</strong> section can be:</p>
<ul>
<li><strong>dns</strong>: a list of dns service with the ip address of a dns server</li>
<li><strong>dnsFromIPPool</strong>: the IPPool from which to fetch the dns servers list</li>
</ul>
<h2><a class="header" href="#the-metal3dataclaim-object" id="the-metal3dataclaim-object">The Metal3DataClaim object</a></h2>
<p>A new object would be created, a Metal3DataClaim type.</p>
<pre><code class="language-yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
kind: Metal3DataClaim
metadata:
  name: machine-1
  namespace: default
  ownerReferences:
  - apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
    controller: true
    kind: Metal3Machine
    name: machine-1
spec:
  template:
    name: nodepool-1
status:
  renderedData:
    name: nodepool-1-0
  errorMessage: &quot;&quot;
</code></pre>
<p>The <em>Metal3DataClaim</em> object will reference its target <em>Metal3DataTemplate</em>
object. In its status, the <em>renderedData</em> would reference the <em>Metal3Data</em>
object when it would be generated. In case of error, the <em>errorMessage</em> would
contain a description of the error.</p>
<h2><a class="header" href="#the-metal3data-object" id="the-metal3data-object">The Metal3Data object</a></h2>
<p>The output of the controller would be a Metal3Data object,one per node linking to the
Metal3DataTemplate object and the associated secrets</p>
<p>The Metal3Data object would be:</p>
<pre><code class="language-yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
kind: Metal3Data
metadata:
  name: nodepool-1-0
  namespace: default
  ownerReferences:
  - apiVersion: infrastructure.cluster.x-k8s.io/v1alpha4
    controller: true
    kind: Metal3DataTemplate
    name: nodepool-1
spec:
  index: 0
  metaData:
    name: machine-1-metadata
    namespace: default
  networkData:
    name: machine-1-metadata
    namespace: default
  metal3Machine:
    name: machine-1
    namespace: default
status:
  ready: true
  error: false
  errorMessage: &quot;&quot;
</code></pre>
<p>The Metal3Data will contain the index of this node, and links to the secrets
generated and to the Metal3Machine using this Metal3Data object.</p>
<p>If the Metal3DataTemplate object is updated, the generated secrets will not be
updated, to allow for reprovisioning of the nodes in the exact same state as
they were initially provisioned. Hence, to do an update, it is necessary to do
a rolling upgrade of all nodes.</p>
<p>The reconciliation of the Metal3DataTemplate object will also be triggered by
changes on Metal3Machines. In the case that a Metal3Machine gets modified, if
the <code>dataTemplate</code> references a Metal3DataTemplate, that <em>Metal3DataClaim</em>
object will be reconciled. There will be two cases:</p>
<ul>
<li>An already generated Metal3Data object exists for that <em>Metal3DataClaim</em>. If
the reference is not in the <em>Metal3DataClaim</em> object, the reconciler will add
it. The reconciler will also verify that the required secrets exist. If they
do not, they will be created.</li>
<li>if no Metal3Data exists for that <em>Metal3DataClaim</em>, then the
reconciler will create one and fill the respective field with the secret name.</li>
</ul>
<p>To create a Metal3Data object, the <em>Metal3DataClaim</em> controller will select an
index for that Metal3Machine. The selection happens by selecting the lowest
available index that is not in use. To do that, the controller will list all
existing Metal3Data object linked to this Metal3DataTemplate and to get the
unavailable indexes. The indexes always start from 0 and increment by 1. The
lowest available index is to be used next. The <code>dataNames</code> field contains the
map of Metal3Machine to Metal3Data and the <code>indexes</code> contains the map of
allocated indexes and claims.</p>
<p>Once the next lowest available index is found, it will create the Metal3Data
object. The name would be a concatenation of the Metal3DataTemplate name and
index. Upon conflict, it will fetch again the list to consider the new list of
Metal3Data and try to create the new object with the new index, this will happen
until the new object is created successfully. Upon success, it will render the
content values, and create the secrets containing the rendered data. The
controller will generate the content based on the <code>metaData</code> or <code>networkData</code>
field of the Metal3DataTemplate Specs. The <em>ready</em> field in <em>renderedData</em> will
then be set accordingly. If any error happens during the rendering, an error
message will be added.</p>
<h3><a class="header" href="#the-generated-secrets-1" id="the-generated-secrets-1">The generated secrets</a></h3>
<p>The name of the secret will be made of a prefix and the index. The Metal3Machine
object name will be used as the prefix. A <code>-metadata-</code> or <code>-networkdata-</code> will
be added between the prefix and the index.</p>
<h2><a class="header" href="#deployment-flow-1" id="deployment-flow-1">Deployment flow</a></h2>
<h3><a class="header" href="#manual-secret-creation-1" id="manual-secret-creation-1">Manual secret creation</a></h3>
<p>In the case where the Metal3Machine is created without a <code>dataTemplate</code> value,
if the <code>metaData</code> or <code>networkData</code> fields are set (one or both), the
Metal3Machine reconciler will fetch the secret, set the status field and
directly start the provisioning of the BareMetalHost using the secrets if given.
If one of the secrets does not exist, the controller will wait to start the
provisioning of the BareMetalHost until it exists.</p>
<h3><a class="header" href="#dynamic-secret-creation-1" id="dynamic-secret-creation-1">Dynamic secret creation</a></h3>
<p>In the case where the Metal3Machine is created with a <code>dataTemplate</code> value, the
Metal3Machine reconciler will create a <em>Metal3DataClaim</em> for that object.</p>
<p>The <em>Metal3DataClaim</em> would then be reconciled, and its controller will create
an index for this <em>Metal3DataClaim</em> if it does not exist yet, and create a
Metal3Data object with the index. Upon success, it will set the <em>ready</em> field
to true, and the <em>renderedData</em> field to reference the <em>Metal3Data</em> object.</p>
<p>The Metal3Data reconciler will then generate the secrets, based on the index,
the Metal3DataTemplate and the machine. Once created, it will set the status
field <code>ready</code> to True.</p>
<p>Once the Metal3Data object is ready, the Metal3Machine controller will fetch
the secrets that have been created (one or both) and use them to start
provisioning the BareMetalHost.</p>
<h3><a class="header" href="#hybrid-configuration-1" id="hybrid-configuration-1">Hybrid configuration</a></h3>
<p>If the Metal3Machine object is created with a <code>dataTemplate</code> field set, but one
of the <code>metaData</code> or <code>networkData</code> is also set in the spec, this one will
override the template generation for this specific secret. i.e. if the user sets
the three fields, the controller will use the user input secret for both.</p>
<p>This means that some hybrid scenarios are supported, where the user can give
directly the <code>metaData</code> secret and let the controller render the <code>networkData</code>
secret through the Metal3DataTemplate object.</p>
<h2><a class="header" href="#metal3-dev-env-examples" id="metal3-dev-env-examples">Metal3 dev env examples</a></h2>
<p>You can find CR examples in the
<a href="https://github.com/metal3-io/metal3-dev-env">Metal3-io dev env project</a>,
in the <a href="https://github.com/metal3-io/metal3-dev-env/tree/master/vm-setup/roles/v1aX_integration_test/templates">template
folder</a>.</p>
<h1><a class="header" href="#metal³-development-environment" id="metal³-development-environment">Metal³ Development Environment</a></h1>
<p>This repository includes scripts to set up a Metal³ development environment.</p>
<h2><a class="header" href="#build-status" id="build-status">Build Status</a></h2>
<p><a href="https://jenkins.nordix.org/view/Airship/job/airship_master_v1a3_integration_test_ubuntu"><img src="https://jenkins.nordix.org/view/Airship/job/airship_master_v1a3_integration_test_ubuntu/badge/icon?subject=Ubuntu%20E2E%20V1alpha3" alt="Ubuntu V1alpha3 build status" /></a>
<a href="https://jenkins.nordix.org/view/Airship/job/airship_master_v1a3_integration_test_centos"><img src="https://jenkins.nordix.org/view/Airship/job/airship_master_v1a3_integration_test_centos/badge/icon?subject=CentOS%20E2E%20V1alpha3" alt="CentOS V1alpha3 build status" /></a>
<a href="https://jenkins.nordix.org/view/Airship/job/airship_master_v1a4_integration_test_ubuntu"><img src="https://jenkins.nordix.org/view/Airship/job/airship_master_v1a4_integration_test_ubuntu/badge/icon?subject=Ubuntu%20E2E%20V1alpha4" alt="Ubuntu V1alpha4 build status" /></a>
<a href="https://jenkins.nordix.org/view/Airship/job/airship_master_v1a4_integration_test_centos"><img src="https://jenkins.nordix.org/view/Airship/job/airship_master_v1a4_integration_test_centos/badge/icon?subject=CentOS%20E2E%20V1alpha4" alt="CentOS V1alpha4 build status" /></a></p>
<h2><a class="header" href="#instructions" id="instructions">Instructions</a></h2>
<p>Instructions can be found here: <a href="https://metal3.io/try-it.html">https://metal3.io/try-it.html</a></p>
<h2><a class="header" href="#quickstart" id="quickstart">Quickstart</a></h2>
<p>Versions v1alpha3 or v1alpha4 are later referred as <strong>v1alphaX</strong>.</p>
<p>The v1alphaX deployment can be done with Ubuntu 18.04, 20.04 or Centos 8 target host
images. By default, for Ubuntu based target hosts we are using Ubuntu 20.04</p>
<h3><a class="header" href="#requirements" id="requirements">Requirements</a></h3>
<h4><a class="header" href="#dev-env-size" id="dev-env-size">Dev env size</a></h4>
<p>The requirements for the dev env machine are, when deploying <strong>Ubuntu</strong> target
hosts:</p>
<ul>
<li>8GB of memory</li>
<li>4 cpus</li>
</ul>
<p>And when deploying <strong>Centos</strong> target hosts:</p>
<ul>
<li>16GB of memory</li>
<li>4 cpus</li>
</ul>
<p>The Minikube machine is deployed with 4GB of RAM, and 2 vCPUs, and the target
hosts with 4 vCPUs and 4GB of RAM.</p>
<h3><a class="header" href="#environment-variables" id="environment-variables">Environment variables</a></h3>
<p>Select:</p>
<pre><code class="language-sh">export CAPM3_VERSION=v1alpha3
</code></pre>
<p>or</p>
<pre><code class="language-sh">export CAPM3_VERSION=v1alpha4
</code></pre>
<p>The following environment variables need to be set for <strong>Centos</strong>:</p>
<pre><code class="language-sh">export IMAGE_OS=Centos
</code></pre>
<p>And the following environment variables need to be set for <strong>Ubuntu</strong>:</p>
<pre><code class="language-sh">export IMAGE_OS=Ubuntu
</code></pre>
<p>You can check a list of all the environment variables <a href="submodules/dev-env/vars.html">here</a></p>
<h3><a class="header" href="#deploy-the-metal3-dev-env" id="deploy-the-metal3-dev-env">Deploy the metal3 Dev env</a></h3>
<pre><code class="language-sh">./01_prepare_host.sh
./02_configure_host.sh
./03_launch_mgmt_cluster.sh
</code></pre>
<p>or</p>
<pre><code class="language-sh">make
</code></pre>
<h3><a class="header" href="#deploy-the-target-cluster" id="deploy-the-target-cluster">Deploy the target cluster</a></h3>
<pre><code class="language-sh">./scripts/provision/cluster.sh
./scripts/provision/controlplane.sh
./scripts/provision/worker.sh
</code></pre>
<h3><a class="header" href="#pivot-to-the-target-cluster" id="pivot-to-the-target-cluster">Pivot to the target cluster</a></h3>
<pre><code class="language-sh">./scripts/provision/pivot.sh
</code></pre>
<h3><a class="header" href="#delete-the-target-cluster" id="delete-the-target-cluster">Delete the target cluster</a></h3>
<pre><code class="language-sh">kubectl delete cluster &quot;${CLUSTER_NAME:-&quot;test1&quot;}&quot; -n metal3
</code></pre>
<h3><a class="header" href="#deploying-with-tilt" id="deploying-with-tilt">Deploying with Tilt</a></h3>
<p>It is possible to use Tilt to run the CAPI and CAPM3 components. For this, run:</p>
<pre><code class="language-sh">export EPHEMERAL_CLUSTER=&quot;tilt&quot;
make
</code></pre>
<p>Then clone the Cluster API Provider Metal3 repository, and follow the
<a href="https://github.com/metal3-io/cluster-api-provider-metal3/blob/master/docs/dev-setup.md#tilt-development-environment">instructions</a>.
That will mostly be the three following blocks of commands.</p>
<pre><code class="language-sh">source lib/common.sh
source lib/network.sh
source lib/images.sh
</code></pre>
<p>and go to the CAPM3 repository and run</p>
<pre><code class="language-sh">make tilt-settings
</code></pre>
<p>Please refer to the CAPM3 instructions to include BMO and IPAM. Then run :</p>
<pre><code class="language-sh">make tilt-up
</code></pre>
<p>Once the cluster is running, you can create the BareMetalHosts :</p>
<pre><code class="language-sh">kubectl create namespace metal3
kubectl apply -n metal3 -f /opt/metal3-dev-env/bmhosts_crs.yaml
</code></pre>
<p>Afterwards, you can deploy a target cluster.</p>
<p>If you are running tilt on a remote machine, you can forward the web interface
by adding the following parameter to the ssh command <code>-L 10350:127.0.0.1:10350</code></p>
<p>Then you can access the Tilt dashboard locally <a href="http://127.0.0.1:10350">here</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
